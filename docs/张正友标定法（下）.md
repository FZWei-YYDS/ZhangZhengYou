# 03 相机模型

## 3.1 四大坐标系

最为常用的针孔相机模型是由小孔成像模型演变过来的（因此很多高精度重建算法中我们希望光圈尽可能下）：

| <img src="https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505105420925.png" alt="image-20220505105420925" style="zoom:67%;" /> | ![image-20220505112035782](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505112035782.png) |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|                    **图 1 小孔成像模型**                     |                **图2 针孔相机模型（未翻转）**                |

其中：$P$：物点、$P'$：像点、$f$：焦距、$O_c$：光心、$O'xy$：成像平面（CCD）。将其进行翻转即实际的针孔相机模型（避免了上下翻转，电子实现），它由四大坐标系构成：世界坐标系、相机坐标系、

| ![image-20220505112424388](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505112424388.png) |
| :----------------------------------------------------------: |
|               **图3 针孔相机模型：四大坐标系**               |

### (1) 世界坐标系->相机坐标系

| <img src="https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505112251643.png" alt="image-20220505112251643" style="zoom:80%;" /> |
| :----------------------------------------------------------: |
|               **图4 世界坐标系 -> 相机坐标系**               |

> **世界坐标系（3D）**：以外界某个参考点建立的坐标系，单位为 $mm$，或者 $m$。
>
> **相机坐标系（3D）**：以相机光心建立的坐标系，其 $z$ 轴指向相机的正前方。

假设物点在世界坐标系下的坐标为：$P=[X_W,Y_W,Z_W]$，那么转换到相机坐标系下坐标：$P=[X_C,Y_C,Z_C]^T$ 的变换如下：
$$
\left[ {\begin{array}{*{20}{c}}
  {{X_C}} \\ 
  {{Y_C}} \\ 
  {{Z_C}}
\end{array}} \right] = R_{3\times 3}\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} 
\end{array}} \right] + T_{3 \times 1} \Rightarrow \left[ {\begin{array}{*{20}{c}}
  {{X_C}} \\ 
  {{Y_C}} \\ 
  {{Z_C}} \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  R_{3 \times 3}&T_{3 \times 1} \\ 
  0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$

> 注：齐次坐标系的使用在于统一旋转和平移。

### (2) 相机坐标系->图像坐标系

| ![image-20220505112818640](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505112818640.png) |
| :----------------------------------------------------------: |
|                **图5 相机坐标系->图像坐标系**                |

> **图像坐标系（2D）**：以光心在成像平面的投影为原点建立的坐标系，称为图像坐标系。

将像点 $p$ 记为：$p=[x,y]^T$，根据简单的相似三角形关系，很容易有：
$$
\frac{{{X_c}}}{x} = \frac{{{Z_c}}}{f} = \frac{{{Y_c}}}{y} \Rightarrow x = f\frac{{{X_c}}}{{{Z_c}}},y = f\frac{{{Y_c}}}{{{Z_c}}}
$$
与之前公式统一，写为齐次形式：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  x \\ 
  y \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  f&0&0&0 \\ 
  0&f&0&0 \\ 
  0&0&1&0 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_C}} \\ 
  {{Y_C}} \\ 
  {{Z_C}} \\ 
  1 
\end{array}} \right]
$$

### (3) 图像坐标系->像素坐标系

> **像素坐标系（2D）**：我们最终用户所看到的，也就是坐标系的原点在图像左上角，单位为像素。

| ![image-20220505145927099](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505145927099.png) |
| :----------------------------------------------------------: |
|               **图6 图像坐标系 -> 像素坐标系**               |

我们用 $u,v$ 来记像素的列数与行数，那么：

- 图像坐标系下的坐标系原点，在像素坐标系 $u-v$ 下记为：$o(u_0,v_0)$
- 像点 $p$，在 $u-v$ 坐标系下记为：$p(u,v)$

此外，再分别记 $dx,dy$ 为每个像素在 $x$ 轴、$y$ 轴所代表的物理尺寸大小（CMOS查询），我们很容易可以从上图可以从上图上推导出下列关系：
$$
\left\{ {\begin{array}{*{20}{c}}
  {\left( {u - {u_0}} \right)dx = x} \\ 
  {\left( {v - {v_0}} \right)dy = y} 
\end{array}} \right.
$$
将其进行移项，并写为齐次的形式，有：
$$
\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {\frac{1}{{dx}}}&0&{{u_0}} \\ 
  0&{\frac{1}{{dy}}}&{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  x \\ 
  y \\ 
  1 
\end{array}} \right]
$$

### (4) 四大坐标系总结

总结来说，相机成像系统中共包含4个坐标系：世界坐标系、相机坐标系、图像坐标系、像素坐标系，如下图所示：

| ![image-20220505145902918](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505145902918.png) |
| :----------------------------------------------------------: |
| **图7 四大坐标系：世界坐标系、相机坐标系、图像坐标系、像素坐标系** |

这四个坐标系之间的转化关系为：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {1/dx}&0&{{u_0}} \\ 
  0&{1/dy}&{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left( {\begin{array}{*{20}{c}}
  f&0&0&0 \\ 
  0&f&0&0 \\ 
  0&0&1&0 
\end{array}} \right)\left( {\begin{array}{*{20}{c}}
  {{R_{3 \times 3}}}&{{T_{3 \times 1}}} \\ 
  0&1 
\end{array}} \right)\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$
将上式合并运算：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&0&{{u_0}} \\ 
  0&{f/dy}&{{v_0}}\\ 
  0&0&1 
  
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{R_{3 \times 3}}}&{{T_{3 \times 1}}} 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$

其中：

- $[u,v]^T$：某点的像素坐标
- $[X_W,Y_W,Z_W,1]^T$：某点的世界坐标
- $dx,dy$：单个像素在 $x,y$ 方向的物理大小
- $f$：相机的焦距
- $u_0,v_0$：相机主点在像素坐标系下的坐标
- $Z_c$：尺度因子

有时我们也会增加对CMOS传感器 $u、v$ 轴的倾斜角 $\theta$ 的考虑，则上述公式变为：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&{ - f\cot \theta /dx}&{{u_0}} \\ 
  0&{f/\left( {\sin \theta dy} \right)}&{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{R_{3 \times 3}}}&{{T_{3 \times 1}}} 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$
它们都可以记为：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  \alpha &\gamma &{{u_0}} \\ 
  0&\beta &{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{R_{3 \times 3}}}&{{T_{3 \times 1}}} 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$
通常：

- **内参**：是相机的本质属性，在不调整相机焦距、光圈的情况下不会发生改变。
- **外参**：取决于相机坐标系（相机为中心）和世界坐标系（通常是标定板左上角的角点）的相互位姿关系。

### (5) 补充：归一化坐标系

| <img src="https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505161957866.png" alt="image-20220505161957866" style="zoom:67%;" /> |
| :----------------------------------------------------------: |
|      **图8 归一化平面：成像平面距离光心距离z归一化到1**      |

> **归一化坐标系(2D)**：用于校正相机畸变校正，其将成像平面距离光心距离z归一化到1。

从世界坐标系到像素坐标系转换有：
$$

$$


显然从相机坐标系到像素坐标系的转换有（在不考虑倾斜轴的情况下）：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&0&{{u_0}}&0 \\ 
  0&{f/dy}&{{v_0}}&0 \\ 
  0&0&1&0 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_C}} \\ 
  {{Y_C}} \\ 
  {{Z_C}} \\ 
  1 
\end{array}} \right]
$$
两式同除以 $Z_c$，$P$ 点被变换到了距离光心距离为1的点，即 $P_N=(X_N,Y_N)$，那么显然有：
$$
\begin{gathered}
  \left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&0&{{u_0}}&0 \\ 
  0&{f/dy}&{{v_0}}&0 \\ 
  0&0&1&0 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_C}/{Z_c}} \\ 
  {{Y_C}/{Z_c}} \\ 
  1 \\ 
  1 
\end{array}} \right] \hfill \\
   \Downarrow  \hfill \\
  \left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&0&{{u_0}} \\ 
  0&{f/dy}&{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_N}} \\ 
  {{Y_N}} \\ 
  1 
\end{array}} \right] \hfill \\ 
\end{gathered}
$$
该坐标系经常被用于相机的畸变校正算法。

##  3.2 相机畸变

之前的模型没有考虑畸变情况，事实上，在工业相机中畸变并不明显，但是如果采用的是普通相机，那么我们最好是对镜头的畸变进行校正，主要包含：

- 径向畸变（三阶）：
  $$
  \begin{array}{l}
  \hat x = x\left( {1 + {k_1}{r^2} + {k_2}{r^4} + {k_3}{r^6}} \right)\\
  \hat y = y\left( {1 + {k_1}{r^2} + {k_2}{r^4} + {k_3}{r^6}} \right)
  \end{array}
  $$
  注：拟合系数并非越多越好，有可能发生过拟合现象，通常来说我们系数 $k_3$ 只在鱼眼相机等畸变较大的相机中才会使用。另外，针对这类畸变较大的特殊相机，有时候为了提高标定精度，我们会采用专门的相机模型进行成像描述，而非针孔相机模型。

- 切向畸变：
  $$
  \begin{array}{l}
  \hat x = x + 2{p_1}y + {p_2}\left( {{r^2} + 2{x^2}} \right)\\
  \hat y = y + 2{p_2}x + {p_1}\left( {{r^2} + 2{y^2}} \right)
  \end{array}
  $$

其中：

- $(x,y)$：无畸变归一化平面下像素点的坐标
- $x’,y'$：发生畸变后像素点的坐标
- $r^2=x^2+y^2$：像素点到中心的曲率半径

> 至于如何进行畸变校正呢？实际的高精度的畸变校正并非那么简单，后面我们配合代码端进行讲解，保证大家每一个模块都能吃透理论知识。

# 04 张正友标定法

> 很多时候我们用张正友标定法，只是调用了下OpenCV的库，并不清楚内部是如何实现的。这针对一般的使用者来说无可厚非（甚至我觉得是推荐，因为你很难很清楚地了解每一个算法的细节，而且完全没有必要，一个人的精力是有限的，你要把精力放在你着重的地方）。**但是如果你像我一样需要自己写一个高精度的相机标定算法，那么势必要读一些新的论文，要自己去实现优化过程。**

张正友标定法利用上图所示的棋盘格标定板进行标定：

| <img src="https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220422112656562.png" alt="image-20220422112656562" style="zoom:150%;" /> |
| :----------------------------------------------------------: |
|              **图2 张正友标定法拍照使用的图片**              |

在得到一张标定板图案后，基于世界坐标系、像素坐标系建立，可以得到角点相应的坐标：

- **世界坐标系**：以棋盘格左上角的角点为原点建立的三轴坐标系，由于每个棋盘格的大小是已知的，因此我们可以计算出每个角点的世界坐标系下坐标：$p=(X,Y,0)$
- **像素坐标系**：以图像左上角为原点建立的两轴坐标系，利用图像检测算法可以获得每个角点的像素坐标系下坐标：$p=(u,v)$

我们来回顾一下之前的方程：
$$
s\left[ {\begin{array}{*{20}{c}}
u\\
v\\
1
\end{array}} \right] = \underbrace {\left[ {\begin{array}{*{20}{c}}
{\frac{{{f_x}}}{{dx}}}&{ - \frac{{{f_y} \cdot \cot \theta }}{{dx}}}&{{u_0}}\\
0&{\frac{{{f_y}}}{{\sin \theta  \cdot dy}}}&{{v_0}}\\
0&0&1
\end{array}} \right]}_{内参}\underbrace {\left[ {\begin{array}{*{20}{c}}
R_{3 \times 3}&t_{3 \times 1}\\
\end{array}} \right]}_{外参}\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
Z\\
1
\end{array}} \right] \label{3}
$$
这个函数包含2个矩阵，多个未知数，直接去求解并不容易，我们可以将初值的求解过程分为三步：

1. 求解内参矩阵与外参矩阵的积，即**单应性矩阵**。
2. 求解内参矩阵，这个矩阵对于不同的图片来说是个定值。
3. 求解外参矩阵，对于同一张图片来说，所有的角点是定值。

## 4.1 求解单应性矩阵 H

### (1）计算初值

> **单应性矩阵**
>
> 1. 物体平面到成像平面的转换：
>
>    ![img](https://pic2.zhimg.com/80/v2-45c1e0c782df7b13053ccdd5d8d50119_720w.jpg)
>
> 2. 从不同位置拍摄的，同一个平面的两个图像之间的转换（转换2次），如下图所示，原来是侧向拍摄，通过单应性矩阵转换到正向：
>
>    ![img](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/v2-c65fa108859d5d41397a60744a0caf78_720w.jpg)
>
>    ![img](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/v2-2706c8ff1c3c8f79d137691ba5b640ac_720w.jpg)

我们记旋转矩阵 $R$ 的每一列为 $R_1,R_2,R_3$，内参矩阵记为 $A$，并且标定板上任意一点的 $Z=0$，那么显然 $Eq. \ref{3}$ 有如下简化方式：
$$
s\left[ {\begin{array}{*{20}{c}}
u\\
v\\
1
\end{array}} \right] = A\left[ {\begin{array}{*{20}{c}}
{{R_1}}&{{R_2}}&{{R_3}}&t
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
0\\
1
\end{array}} \right] = A\left[ {\begin{array}{*{20}{c}}
{{R_1}}&{{R_2}}&t
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
1
\end{array}} \right]
$$
其中 $s$ 是尺度系数，显然，上述公式也可以写作：
$$
\left[ {\begin{array}{*{20}{c}}
{\underline u }\\
{\underline v }\\
{\underline s }
\end{array}} \right]=

\left[ {\begin{array}{*{20}{c}}

s \cdot u \\
s \cdot v\\
s
\end{array}} \right] =


\left[ {\begin{array}{*{20}{c}}
{{H_{11}}}&{{H_{12}}}&{{H_{13}}}\\
{{H_{21}}}&{{H_{22}}}&{{H_{23}}}\\
{{H_{31}}}&{{H_{32}}}&{{H_{33}}}
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
1
\end{array}} \right] \label{7}
$$
式子中增加下划线说明它是齐次坐标系，具有尺度不变性。

> 注：对于单副图片来说，单应性矩阵是同一个，尺度系数也是同一个。

我们将之前的 $Eq. \ref{7}$ 展开，可得：
$$
\left. \begin{array}{l}
s \cdot u &= {H_{11}}X + {H_{12}}Y + {H_{13}}\\
s \cdot v &= {H_{21}}X + {H_{22}}Y + {H_{23}}\\
s &= {H_{31}}X + {H_{32}}Y + {H_{33}}
\end{array} \right\} \to \begin{array}{*{20}{c}}
{u = \frac{{{H_{11}}X + {H_{12}}Y + {H_{13}}}}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}\\
{v = \frac{{{H_{21}}X + {H_{22}}Y + {H_{23}}}}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}
\end{array}
$$
进一步变换：
$$
\begin{array}{c}
\left\{ {\begin{array}{*{20}{c}}
{u\left( {{H_{31}}X + {H_{32}}Y + {H_{33}}} \right) = {H_{11}}X + {H_{12}}Y + {H_{13}}}\\
{v\left( {{H_{31}}X + {H_{32}}Y + {H_{33}}} \right) = {H_{21}}X + {H_{22}}Y + {H_{23}}}
\end{array}} \right.
\\
 \downarrow 
 \\
\left\{ {\begin{array}{*{20}{c}}
{uX \cdot {H_{31}} + uY \cdot {H_{32}} + u \cdot {H_{33}} - X \cdot {H_{11}} - Y \cdot {H_{12}} - {H_{13}} = 0}\\
{vX \cdot {H_{31}} + vY \cdot {H_{32}} + v \cdot {H_{33}} - X \cdot {H_{21}} - Y \cdot {H_{22}} - {H_{23}} = 0}
\end{array}} \right.
\end{array}
$$

即线性方程组实际含有8个未知数（实际的单应矩阵 $H$ 由于采用非齐次坐标系，[齐次坐标尺度不变性](https://blog.csdn.net/qq_42118719/article/details/112347552)，并非9个），提供了2组约束。因此当一张图片上的标定板角点 $ n \ge 4$，我们即可以利用**最小二乘法**来求得最佳的单应性矩阵 $H$。将其写作线性方程形式：
$$
\left[ {\begin{array}{*{20}{c}}
{\begin{array}{*{20}{c}}
{ - X}&{ - Y}&{ - 1}&0&0&0&{uX}&{uY}&u
\end{array}}\\
{\begin{array}{*{20}{c}}
0&0&0&{ - X}&{ - Y}&{ - 1}&{vX}&{vY}&v
\end{array}}
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{{H_{11}}}\\
{{H_{12}}}\\
{{H_{13}}}\\
{{H_{21}}}\\
{{H_{22}}}\\
{{H_{23}}}\\
{{H_{31}}}\\
{{H_{32}}}\\
{{H_{33}}}
\end{array}} \right] = 0
$$
因此，如果有 $N$ 个点对，那么就可以构成 $N \times 2 $ 个的超定方程来求解：
$$
\left[ {\begin{array}{*{20}{c}}
{ - {X_1}}&{ - {Y_1}}&{ - 1}&0&0&0&{{u_1}{X_1}}&{{u_1}{Y_1}}&{{u_1}}\\
0&0&0&{ - {X_1}}&{ - {Y_1}}&{ - 1}&{{v_1}{X_1}}&{{v_1}{Y_1}}&{{v_1}}\\
 \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
{ - {X_N}}&{ - {Y_N}}&{ - 1}&0&0&0&{{u_N}{X_N}}&{{u_N}{Y_N}}&{{u_N}}\\
0&0&0&{ - {X_N}}&{ - {Y_N}}&{ - 1}&{{v_N}{X_N}}&{{v_N}{Y_N}}&{{v_N}}
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{{H_{11}}}\\
{{H_{12}}}\\
{{H_{13}}}\\
{{H_{21}}}\\
{{H_{22}}}\\
{{H_{23}}}\\
{{H_{31}}}\\
{{H_{32}}}\\
{{H_{33}}}
\end{array}} \right] = 0
$$
一般为了求解方便，在代码中，我们往往将相同的方程放在一起：
$$
\left[ \begin{array}{l}
\begin{array}{*{20}{c}}
{ - {X_1}}&{ - {Y_1}}&{ - 1}&0&0&0&{{u_1}{X_1}}&{{u_1}{Y_1}}&{{u_1}}\\
{ - {X_2}}&{ - {Y_2}}&{ - 1}&0&0&0&{{u_2}{X_2}}&{{u_2}{Y_2}}&{{u_2}}\\
 \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
{ - {X_{N - 1}}}&{ - {Y_{N - 1}}}&{ - 1}&0&0&0&{{u_{N - 1}}{X_{N - 1}}}&{{u_{N - 1}}{Y_{N - 1}}}&{{u_{N - 1}}}\\
{ - {X_N}}&{ - {Y_N}}&{ - 1}&0&0&0&{{u_N}{X_N}}&{{u_{N - 1}}{Y_N}}&{{u_N}{Y_N}}
\end{array}\\
\overline {\begin{array}{*{20}{c}}
0&0&0&{ - {X_1}}&{ - {Y_1}}&{ - 1}&{{v_1}{X_1}}&{{v_1}{Y_1}}&{{v_1}}\\
0&0&0&{ - {X_2}}&{ - {Y_2}}&{ - 1}&{{v_2}{X_2}}&{{v_2}{Y_2}}&{{v_2}}\\
 \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
0&0&0&{ - {X_{N - 1}}}&{ - {Y_{N - 1}}}&{ - 1}&{{v_{N - 1}}{X_{N - 1}}}&{{v_{N - 1}}{Y_{N - 1}}}&{{v_{N - 1}}}\\
0&0&0&{ - {X_N}}&{ - {Y_N}}&{ - 1}&{{v_N}{X_N}}&{{v_{N - 1}}{Y_N}}&{{v_N}{Y_N}}
\end{array}} 
\end{array} \right]\left[ {\begin{array}{*{20}{c}}
{{H_{11}}}\\
{{H_{12}}}\\
{{H_{13}}}\\
{{H_{21}}}\\
{{H_{22}}}\\
{{H_{23}}}\\
{{H_{31}}}\\
{{H_{32}}}\\
{{H_{33}}}
\end{array}} \right] = 0
$$
记号为：
$$
M_{2 N \times 9} \cdot H_{9 \times 1} = 0
$$
利用SVD分解右奇异矩阵 $V$ 的最后一列即可得到 $H$ 矩阵。

### (2）归一化数据

> 归一化方法：假设归一化一2D点集 $X=(x_0,...,x_N)$，记为：
> $$
> X'=Normalize(X) = (x_0',...,x_{N-1}')
> $$
> 具体的数学形式，如果记为
>
> - 齐次坐标，即：
>   $$
>   x_j' = N_x \cdot x_j 
>   $$
>
> - 齐次坐标，即：
>   $$
>   x_j' = hom^{-1}[N_x \cdot hom(x_j)]
>   $$
>
> 其中：
> $$
> {N_X} = \left[ {\begin{array}{*{20}{c}}
> {{s_x}}&0&{ - {s_x}\bar x}\\
> 0&{{s_y}}&{ - {s_y}\overline y }\\
> 0&0&1
> \end{array}} \right], \mathbf{\bar x}= \frac{1}{N}\sum\limits_{j = 1}^N {{x_j}}
> $$
> 相应的逆：
> $$
> N_X^{ - 1} = \left[ {\begin{array}{*{20}{c}}
> {\frac{1}{{{s_x}}}}&0&{\bar x}\\
> 0&{\frac{1}{{{s_y}}}}&{\bar y}\\
> 0&0&1
> \end{array}} \right]
> $$
> 尺度系数 $s$ 有两种计算方式：
>
> 1. 不均等变换
>    $$
>    {s_x} = {s_y} = \sqrt 2  \cdot N \cdot {\left( {\sum\limits_{j = 1}^N {\left\| {{x_j} - \bf{ \overline x }} \right\|} } \right)^{ - 1}}
>    $$
>
> 2. 均等变换：
>    $$
>    \begin{array}{l}
>    {s_x} = \sqrt {2/\sigma _x^2} ,\sigma _x^2 = \frac{1}{N}\sum\limits_{j = 1}^N {\left( {{x_j} - \overline x } \right)} \\
>    {s_y} = \sqrt {2/\sigma _y^2} ,\sigma _y^2 = \frac{1}{N}\sum\limits_{j = 1}^N {\left( {{y_j} - \overline y } \right)} 
>    \end{array}
>    $$

不过在此之前，为了避免求解病态矩阵，先对数据进行归一化，记标记为：
$$
\begin{array}{c}
{\left[ {X',Y'} \right]^T} = Normalize\left( {{{\left[ {X,Y} \right]}^T}} \right)\\
{\left[ {u',v'} \right]^T} = Normalize\left( {{{\left[ {u,v} \right]}^T}} \right)
\end{array}\
$$

归一化矩阵分别记作 $N_X, N_U$，于是单应性方程：
$$
\begin{array}{*{20}{c}}
{\left[ {\begin{array}{*{20}{c}}
u\\
v\\
1
\end{array}} \right] = \frac{1}{s}H\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
1
\end{array}} \right]}\\
 \downarrow \\
{{N_U}\left[ {\begin{array}{*{20}{c}}
u\\
v\\
1
\end{array}} \right] = \frac{1}{s}H' \cdot {N_X}\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
1
\end{array}} \right]}
\end{array}
$$
于是原单应性矩阵：
$$
H = N_U^{ - 1} \cdot H' \cdot {N_X}
$$

### (3）非线性优化

> 注：因为 $H$ 在之后都要进行使用，而且也没有其他未估计的参数，因此我们先进行非线性优化，以提供它的准确性。

> **重投影误差**
>
> | <img src="https://img-blog.csdnimg.cn/692e6118f95c46c297fc31ba6385a6af.jpg?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCR5p2w5b6I5biF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述" style="zoom: 50%;" /> |
> | :----------------------------------------------------------: |
> |                     图 重投影误差示意图                      |
>
> 非线性优化在SLAM中也称为光束法平差实际是在**[最小化重投影误差](https://blog.csdn.net/weixin_49804978/article/details/121922128)**，我们先来说什么是重投影误差：
>
> 1. **初投影**：相机拍照时实际的三维空间点投影到像素平面，经过角点检测，我们可以获得角点的像素坐标（映射）
> 2. **标定内参**：根据这些角点的像素坐标以及相应世界坐标（标定板上的角点世界坐标都是已知），计算获得相机内参、外参矩阵
> 3. **重投影**：将理论上的三维空间点，根据相机内参、外参重新投影到成像平面
>
> 初投影（映射）和重投影之间的像素差值，即为**重投影误差**。

DLT方法计算的参数仅考虑，我们还没考虑重投影误差，而之所以使用重投影误差，是因为它不光考虑了单应矩阵的计算误差，也考虑了图像点的测量误差（检测的角点未必准确），所以其精度会更高一点。公式如下：
$$
{E_{proj}} = \frac{1}{2}{\sum\limits_{j = 1}^N {\left\| {{u_j} - \frac{1}{{{s_j}}}H{X_j}} \right\|} ^2}
$$

对于上式的求解，`scipy` 提供了更简单的[求解方式](https://www.freesion.com/article/18931406638/)，不需要我们手动去定义最小二乘问题（如果用Ceres等求解器需要定义）：

```python
    popt, pcov = scipy.optimize.curve_fit(
                           f=value_function_H,  # 价值函数
                           xdata=x_data,                # X数据
                           ydata=y_data,               # Y数据（标签）
                           p0=h0,                                # 初始值（待优化变量）
                           jac=jac_H                          # 一阶导数
                           )
```

复杂的主要是两个函数：

1. 价值函数：需要拟合的函数，即计算根据之前 $H$ 参数计算的方程：
   $$
   {u = \frac{{{H_{11}}X + {H_{12}}Y + {H_{13}}}}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}\\
   {v = \frac{{{H_{21}}X + {H_{22}}Y + {H_{23}}}}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}
   $$

   ```python
   # 注：x_data是自变量，*params是待优化变量
   def value_function_H(x_data, *params):
       """价值函数"""
       # 传入的P0参数的每个名字
       h11, h12, h13, h21, h22, h23, h31, h32, h33 = params
       N = x_data.shape[0] // 2
       # 世界坐标系
       X, Y = x_data[:N], x_data[N:]
       s = h31 * X + h32 * Y + h33
       u_proj = (h11 * X + h12 * Y + h13) / s
       v_proj = (h21 * X + h22 * Y + h23) / s
       uv_proj = np.zeros_like(x_data)
       uv_proj[:N], uv_proj[N:] = u_proj, v_proj
       return uv_proj
   ```

   注：这里为了赋值方便，把关于 $u$ 的方程全部放在了前面，关于 $v$ 的方程全部放在后面。
   
2. 一阶导数 $J$，对价值函数求偏导：
   $$
   \begin{array}{l}
   \frac{{\partial u}}{{\partial H}} = \left[ {\begin{array}{*{20}{c}}
   {\frac{{\partial u}}{{\partial {H_{11}}}}}&{\frac{{\partial u}}{{\partial {H_{12}}}}}&{\frac{{\partial u}}{{\partial {H_{13}}}}}&{\frac{{\partial u}}{{\partial {H_{21}}}}}&{\frac{{\partial u}}{{\partial {H_{22}}}}}&{\frac{{\partial u}}{{\partial {H_{23}}}}}&{\frac{{\partial u}}{{\partial {H_{31}}}}}&{\frac{{\partial u}}{{\partial {H_{32}}}}}&{\frac{{\partial u}}{{\partial {H_{33}}}}}
   \end{array}} \right]\\
   \frac{{\partial v}}{{\partial H}} = \left[ {\begin{array}{*{20}{c}}
   {\frac{{\partial v}}{{\partial {H_{11}}}}}&{\frac{{\partial v}}{{\partial {H_{12}}}}}&{\frac{{\partial v}}{{\partial {H_{13}}}}}&{\frac{{\partial v}}{{\partial {H_{21}}}}}&{\frac{{\partial v}}{{\partial {H_{22}}}}}&{\frac{{\partial v}}{{\partial {H_{23}}}}}&{\frac{{\partial v}}{{\partial {H_{31}}}}}&{\frac{{\partial v}}{{\partial {H_{32}}}}}&{\frac{{\partial v}}{{\partial {H_{33}}}}}
   \end{array}} \right]
   \end{array}
   $$
   
   $$
   \frac{{\partial u}}{{\partial H}} = {\left[ {\begin{array}{*{20}{c}}
   {\frac{X}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}\\
   {\frac{Y}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}\\
   {\frac{1}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}\\
   0\\
   0\\
   0\\
   { - \frac{{X\left( {{H_{11}}X + {H_{12}}Y + {H_{13}}} \right)}}{{{{\left( {{H_{31}}X + {H_{32}}Y + {H_{33}}} \right)}^2}}}}\\
   { - \frac{{{Y_{11}}\left( {{H_{11}}X + {H_{12}}Y + {H_{13}}} \right)}}{{{{\left( {{H_{31}}X + {H_{32}}Y + {H_{33}}} \right)}^2}}}}\\
   { - \frac{{{H_{11}}X + {H_{12}}Y + {H_{13}}}}{{{{\left( {{H_{31}}X + {H_{32}}Y + {H_{33}}} \right)}^2}}}}
   \end{array}} \right]^T},\frac{{\partial v}}{{\partial H}} = {\left[ {\begin{array}{*{20}{c}}
   0\\
   0\\
   0\\
   {\frac{X}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}\\
   {\frac{Y}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}\\
   {\frac{1}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}\\
   { - \frac{{X\left( {{H_{21}}X + {H_{22}}Y + {H_{23}}} \right)}}{{{{\left( {{H_{31}}X + {H_{32}}Y + {H_{33}}} \right)}^2}}}}\\
   { - \frac{{{Y_{11}}\left( {{H_{21}}X + {H_{22}}Y + {H_{23}}} \right)}}{{{{\left( {{H_{31}}X + {H_{32}}Y + {H_{33}}} \right)}^2}}}}\\
   { - \frac{{{H_{21}}X + {H_{22}}Y + {H_{23}}}}{{{{\left( {{H_{31}}X + {H_{32}}Y + {H_{33}}} \right)}^2}}}}
   \end{array}} \right]^T}
   $$
   
   为了方便，我们记：
   $$
   \begin{array}{l}
   {s_u} = {H_{11}}X + {H_{12}}Y + {H_{13}}\\
   {s_v} = {H_{21}}X + {H_{22}}Y + {H_{23}}\\
   w = {H_{31}}X + {H_{32}}Y + {H_{33}}
   \end{array}
   $$
   于是相应的梯度矩阵：
   $$
   J = \left[ {\begin{array}{*{20}{c}}
   {{J_{2j}}}\\
   {{J_{2j + 1}}}
   \end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
   {\frac{{{X_j}}}{w}}&{\frac{{{Y_j}}}{w}}&{\frac{1}{w}}&0&0&0&{\frac{{ - {s_u}{X_j}}}{{{w^2}}}}&{\frac{{ - {s_u}{Y_j}}}{{{w^2}}}}&{\frac{{ - {s_u}}}{{{w^2}}}}\\
   0&0&0&{\frac{{{X_j}}}{w}}&{\frac{{{Y_j}}}{w}}&{\frac{1}{w}}&{\frac{{ - {s_v}{X_j}}}{{{w^2}}}}&{\frac{{ - {s_v}{Y_j}}}{{{w^2}}}}&{\frac{{ - {s_v}{Y_j}}}{{{w^2}}}}
   \end{array}} \right]
   $$
   
   ```python
   def jac_H(x_data, *params):
       h11, h12, h13, h21, h22, h23, h31, h32, h33 = params
       N = x_data.shape[0] // 2
       X, Y = x_data[:N], x_data[N:]
   
       # h11, h12, h13都是标量，所以直接用乘法
       s_u = h11 * X + h12 * Y + h13
       s_v = h21 * X + h22 * Y + h23
       w   = h31 * X + h32 * Y + h33
       w_2 = w ** 2
   
       J = np.zeros(N * 2, 9)
       J_u, J_v = J[:N, :], J[N:, :]
       J_u[:, 0] = X / w
       J_u[:, 1] = Y / w
       J_u[:, 2] = 1. / w
       J_u[:, 6] = (-s_u * X) / w_2  # 默认逐元素
       J_u[:, 7] = (-s_u * Y) / w_2
       J_u[:, 8] = -s_u / w_2
   
       J_v[:, 3] = X / w
       J_v[:, 4] = Y / w
       J_v[:, 5] = 1. / w
       J_v[:, 6] = (-s_v * X) / w_2
       J_v[:, 7] = (-s_v * Y) / w_2
       J_v[:, 8] = -s_v / w_2
   
       J[:N, :] = J_u
       J[N:, :] = J_v
       return J
   ```
   
   注：这里为了赋值方便，我们同样把关于 $u$ 的方程全部放在了前面，关于 $v$ 的方程全部放在后面。

## 4.2 求解内参矩阵

> 已经求得矩阵：$H = \left[ {\begin{array}{*{20}{c}}
> {{H_1}}&{{H_2}}&{{H_3}}
> \end{array}} \right] = \lambda \cdot A\left[ {\begin{array}{*{20}{c}}
> {R1}&{R2}&t
> \end{array}} \right]$，接下来需要求解相机的内参矩阵 $A$。

由于 $R_1,R_2$  作为 [旋转矩阵](https://zhuanlan.zhihu.com/p/419854977) $R$ 的两列单位正交，即：
$$
\begin{array}{C}
R{_1^T}R_2 = 0\\
R{_1^T}R_1 = R{_2^T}R_2 = 1
\end{array} \label{11}
$$
由 $H$ 和 $R_1、R_2$ 关系可得：
$$
\begin{array}{l}
R_1 = \frac{1}{\lambda} {A^{ - 1}}H_1\\
R_2 =\frac{1}{\lambda} {A^{ - 1}} H_2
\end{array}
$$
联立上述两式可得：
$$
\begin{array}{C}
{\left( {{A^{ - 1}}{H_1}} \right)^T}\left( {{A^{ - 1}}{H_2}} \right) = 0\\
{\left( {{A^{ - 1}}{H_1}} \right)^T}\left( {{A^{ - 1}}{H_1}} \right) = {\left( {{A^{ - 1}}{H_2}} \right)^T}\left( {{A^{ - 1}}{H_2}} \right)  \\
 \downarrow \\
H_1^T{A^{ - T}}{A^{ - 1}}{H_2} = 0\\
H_1^T{A^{ - T}}{A^{ - 1}}{H_1} = H_2^T{A^{ - T}}{A^{ - 1}}{H_2} 
\end{array} \label{13}
$$
由于都出现了$A^{-T} A ^ {-1}$，并且是对称矩阵由于 ${\left( {{A^{ - T}}{A^{ - 1}}} \right)^T} = {A^{ - T}}{A^{ - 1}}$，我们记：
$$
A^{-T}A^{-1}=B=\left[ {\begin{array}{*{20}{c}}
{{B_{11}}}&{{B_{12}}}&{{B_{13}}}\\
{{B_{21}}}&{{B_{22}}}&{{B_{23}}}\\
{{B_{31}}}&{{B_{32}}}&{{B_{33}}}
\end{array}} \right] =\left[ {\begin{array}{*{20}{c}}
{{B_{11}}}&{{B_{12}}}&{{B_{13}}}\\
{{B_{12}}}&{{B_{22}}}&{{B_{23}}}\\
{{B_{13}}}&{{B_{23}}}&{{B_{33}}}
\end{array}} \right]
$$
于是 $Eq. \ref{13}$ 可以写为：
$$
H_1^TB{H_2} = 0\\
H_1^TB{H_1} = H_2^TB{H_2}
$$
令：${H_i} = \left[ {\begin{array}{*{20}{c}}
  {{h_{1i}}} \\ 
  {{h_{2i}}} \\ 
  {{h_{3i}}} 
\end{array}} \right]$，相应的 ${H_j} = \left[ {\begin{array}{*{20}{c}}
  {{h_{1j}}} \\ 
  {{h_{2j}}} \\ 
  {{h_{3j}}} 
\end{array}} \right]$，上述式子都可以写为$H_i^TBH_j$的形式：
$$
\begin{array}{l}
H_i^TB{H_j} 
&= \left[ {\begin{array}{*{20}{c}}
{{H_{1i}}}&{{H_{2i}}}&{{H_{3i}}}
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{{B_{11}}}&{{B_{12}}}&{{B_{13}}}\\
{{B_{12}}}&{{B_{22}}}&{{B_{23}}}\\
{{B_{13}}}&{{B_{23}}}&{{B_{33}}}
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{{H_{1j}}}\\
{{H_{2j}}}\\
{{H_{3j}}}
\end{array}} \right]\\

 &= {\left[ {\begin{array}{*{20}{c}}
{{H_{1i}}{B_{11}} + {H_{2i}}{B_{12}} + {H_{3i}}{B_{13}}}\\
{{H_{1i}}{B_{12}} + {H_{2i}}{B_{22}} + {H_{3i}}{B_{23}}}\\
{{H_{1i}}{B_{13}} + {H_{2i}}{B_{23}} + {H_{3i}}{B_{33}}}
\end{array}} \right]^T}\left[ {\begin{array}{*{20}{c}}
{{H_{1j}}}\\
{{H_{2j}}}\\
{{H_{3j}}}
\end{array}} \right]\\

 &= \left( {{H_{1i}}{B_{11}} + {H_{2i}}{B_{12}} + {H_{3i}}{B_{13}}} \right){H_{1j}} + \left( {{H_{1i}}{B_{12}} + {H_{2i}}{B_{22}} + {H_{3i}}{B_{23}}} \right){H_{2j}}\\
 &\quad + \left( {{H_{1i}}{B_{13}} + {H_{2i}}{B_{23}} + {H_{3i}}{B_{33}}} \right){H_{3j}}\\
 &= \left( {{H_{1i}}{H_{1j}}} \right){B_{11}} + \left( {{H_{2i}}{H_{1j}} + {H_{1i}}{H_{2j}}} \right){B_{12}} + \left( {{H_{3i}}{H_{1i}} + {H_{1i}}{H_{3j}}} \right){B_{13}}\\
 & \quad + \left( {{H_{2i}}{H_{2j}}} \right){B_{22}} + \left( {{H_{3i}}{H_{2j}} + {H_{2i}}{H_{3j}}} \right){B_{23}} + \left( {{H_{3i}}{H_{3j}}} \right){B_{33}}
\end{array}
$$
写成矩阵形式 ：
$$
v_{ij}^Tb = {\left[ {\begin{array}{*{20}{c}}
  {{v_1} = {H_{1i}}{H_{1j}}} \\ 
  {{v_2} = {H_{2i}}{H_{1j}} + {H_{1i}}{H_{2j}}} \\ 
  {{v_3} = {H_{2i}}{H_{2j}}} \\ 
  {{v_4} = {H_{3i}}{H_{1i}} + {H_{1i}}{H_{3j}}} \\ 
  {{v_5} = {H_{3i}}{H_{2j}} + {H_{2i}}{H_{3j}}} \\ 
  {{v_6} = {H_{3i}}{H_{3j}}} 
\end{array}} \right]^T}\left[ {\begin{array}{*{20}{c}}
  {{B_{11}}} \\ 
  {{B_{12}}} \\ 
  {{B_{22}}} \\ 
  {{B_{13}}} \\ 
  {{B_{23}}} \\ 
  {{B_{33}}} 
\end{array}} \right]
$$
结合 $Eq. \ref{11}$ $R_1、R_2$ 单位正交得到的约束：
$$
\begin{array}{*{20}{c}}
{v_{12}^Tb = 0}\\
{v_{11}^Tb = v_{22}^Tb }
\end{array} \to \left[ {\begin{array}{*{20}{c}}
{v_{12}^T}\\
{v_{11}^T - v_{22}^T}
\end{array}} \right]b = vb = 0
$$
由于 $H$ 是已知的，也就是 $v$ 是已知的，该方程包含有6个未知数 $B_{ij}$，2个约束，因此需要至少3组数据，通过最小二乘法即可获得 $b$。因为一个标定板的位姿仅提供一个 $v$ 的值（$v$ 是有单应性矩阵 $H$ 构成的），因此至少需要3张标定板图片。通常我们利用 15 到 20 张图片，通过最小二乘法SVD解法获得 $b$ 的值：

---

在获得 $b$ 后，我们进而可以获得 $B$ 矩阵，记相机内参：
$$
A = \left[ {\begin{array}{*{20}{c}}
{{f_x}/dx}&{ - \cot \theta /dx}&{{u_0}}\\
0&{1/dy \cdot \sin \theta }&{{v_0}}\\
0&0&1
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
\alpha &\gamma &{{u_0}}\\
0&\beta &{{v_0}}\\
0&0&1
\end{array}} \right]
$$
于是 $A^{-1}$（增广矩阵求逆）：
$$
\begin{gathered}
  {A^{ - 1}} \to \left[ {\begin{array}{*{20}{c}}
  \alpha &\gamma &{{\mu _0}}&1&0&0 \\ 
  0&\beta &{{v_0}}&0&1&0 \\ 
  0&0&1&0&0&1 
\end{array}} \right] \to \left[ {\begin{array}{*{20}{c}}
  1&{\frac{\gamma }{\alpha }}&{\frac{{{\mu _0}}}{\alpha }}&{\frac{1}{\alpha }}&0&0 \\ 
  0&1&{\frac{{{v_0}}}{\beta }}&0&{\frac{1}{\beta }}&0 \\ 
  0&0&1&0&0&1 
\end{array}} \right] \hfill \\
   \to \left[ {\begin{array}{*{20}{c}}
  1&{\frac{\gamma }{\alpha }}&0&{\frac{1}{\alpha }}&0&{ - \frac{{{\mu _0}}}{\alpha }} \\ 
  0&1&0&0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }} \\ 
  0&0&1&0&0&1 
\end{array}} \right] \to \left[ {\begin{array}{*{20}{c}}
  1&0&0&{\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{ - \frac{{{\mu _0}}}{\alpha } + \frac{{{v_0}}}{\beta }\frac{\gamma }{\alpha }} \\ 
  0&1&0&0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }} \\ 
  0&0&1&0&0&1 
\end{array}} \right] \hfill \\
   \to \left[ {\begin{array}{*{20}{c}}
  1&0&0&{\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{{v_0}\gamma  - {\mu _0}\beta }}{{\alpha \beta }}} \\ 
  0&1&0&0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }} \\ 
  0&0&1&0&0&1 
\end{array}} \right] \hfill \\ 
\end{gathered} 
$$
于是$A^{-1}$:
$$
{A^{ - 1}} = \left[ {\begin{array}{*{20}{c}}
  {\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{{v_0}\gamma  - {\mu _0}\beta }}{{\alpha \beta }}} \\ 
  0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }} \\ 
  0&0&1 
\end{array}} \right]
$$
计算 $(A^{-1})^T A^{-1}$：
$$
\begin{gathered}
  {\left( {{A^{ - 1}}} \right)^T}{A^{ - 1}} = \left[ {\begin{array}{*{20}{c}}
  {\frac{1}{\alpha }}&0&0 \\ 
  { - \frac{\gamma }{{\alpha \beta }}}&{\frac{1}{\beta }}&0 \\ 
  {\frac{{{v_0}\gamma  - {\mu _0}\beta }}{{\alpha \beta }}}&{ - \frac{{{v_0}}}{\beta }}&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{{v_0}\gamma  - {\mu _0}\beta }}{{\alpha \beta }}} \\ 
  0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }} \\ 
  0&0&1 
\end{array}} \right] \hfill \\
   = \left[ {\begin{array}{*{20}{c}}
  {\frac{1}{{{\alpha ^2}}}}&{ - \frac{\gamma }{{{\alpha ^2}\beta }}}&{\frac{{{v_0}\gamma  - {\mu _0}\beta }}{{{\alpha ^2}\beta }}} \\ 
  { - \frac{\gamma }{{{\alpha ^2}\beta }}}&{\frac{{{\gamma ^2} + {\alpha ^2}}}{{{\alpha ^2}{\beta ^2}}}}&{\frac{{\gamma \left( {{\mu _0}\beta  - {v_0}\gamma } \right)}}{{{\alpha ^2}{\beta ^2}}} - \frac{1}{{{\beta ^2}}}} \\ 
  {\frac{{{v_0}\gamma  - {\mu _0}\beta }}{{{\alpha ^2}\beta }}}&{\frac{{\gamma \left( {{\mu _0}\beta  - {v_0}\gamma } \right)}}{{{\alpha ^2}{\beta ^2}}} - \frac{1}{{{\beta ^2}}}}&1 
\end{array}} \right] \hfill \\ 
\end{gathered}
$$
该式子无法直接求出内参，我们注意到它是个对称矩阵，另外由于求解出的 $B$ 丢失了尺度因子 $\lambda$，于是利用Cholesky分解：
$$
\begin{array}{*{20}{c}}
  {B = \lambda {A^{ - T}}{A^{ - 1}} = \underbrace {\left[ {\sqrt \lambda  {{\left( {{A^{ - 1}}} \right)}^T}} \right]}_L\underbrace {\left[ {\sqrt \lambda  {A^{ - 1}}} \right]}_{{L^T}}} \\ 
  {\left[ {\begin{array}{*{20}{c}}
  {{B_{11}}}&{{B_{12}}}&{{B_{13}}} \\ 
  {{B_{12}}}&{{B_{22}}}&{{B_{23}}} \\ 
  {{B_{13}}}&{{B_{23}}}&{{B_{33}}} 
\end{array}} \right] = \left( {\sqrt \lambda  \left[ {\begin{array}{*{20}{c}}
  {\frac{1}{\alpha }}&0&0 \\ 
  { - \frac{\gamma }{{\alpha \beta }}}&{\frac{1}{\beta }}&0 \\ 
  {\frac{{\gamma {v_0} - \beta {\mu _0}}}{{\alpha \beta }}}&{ - \frac{{{v_0}}}{\beta }}&1 
\end{array}} \right]} \right)\left( {\sqrt \lambda  \left[ {\begin{array}{*{20}{c}}
  {\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{\gamma {v_0} - \beta {\mu _0}}}{{\alpha \beta }}} \\ 
  0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }} \\ 
  0&0&1 
\end{array}} \right]} \right)} 
\end{array}
$$
> 注：虽然 B 肯定是对称的，但它不一定是正定的，因为 $\lambda$ 可能是负的。 一个简单的正定性测试是检查所有对角线元素是否都是非负的。如果不是，将Cholesky分解应用于 $-B$。

现在我们对矩阵 $B$ 通过Cholesky分解（推导较为复杂）进行分解，求解过程如下，为了标记方便，我们将矩阵 $B$ 重新进行标记，记为：

Step 1:
$$
\begin{gathered}
  B = \left[ {\begin{array}{*{20}{c}}
  {{B_0}}&{{B_1}}&{{B_3}} \\ 
  {{B_1}}&{{B_2}}&{{B_4}} \\ 
  {{B_3}}&{{B_4}}&{{B_5}} 
\end{array}} \right] \hfill \\
   \downarrow  \hfill \\
  {l_{11}} = \sqrt {{B_0}}  \hfill \\
  {L_{21}} = \frac{1}{{\sqrt {{B_0}} }}\left[ {\begin{array}{*{20}{c}}
  {{B_1}} \\ 
  {{B_3}} 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {{B_1}/\sqrt {{B_0}} } \\ 
  {{B_3}/\sqrt {{B_0}} } 
\end{array}} \right] \hfill \\
  {L_{22}}L_{22}^T = {A_{22}} - {L_{21}}L_{21}^T = \left[ {\begin{array}{*{20}{c}}
  {{B_2} - B_1^2/{B_0}}&{{B_4} - {B_1}{B_3}/{B_0}} \\ 
  {{B_4} - {B_1}{B_3}/{B_0}}&{{B_5} - B_3^2/{B_0}} 
\end{array}} \right] \hfill \\ 
\end{gathered}
$$

$$
\begin{gathered}
  \left[ {\begin{array}{*{20}{c}}
  {{B_2} - B_1^2/{B_0}}&{{B_4} - {B_1}{B_3}/{B_0}} \\ 
  {{B_4} - {B_1}{B_3}/{B_0}}&{{B_5} - B_3^2/{B_0}} 
\end{array}} \right] \hfill \\
   \downarrow  \hfill \\
  {l_{11}} = \sqrt {{B_2} - B_1^2/{B_0}}  \hfill \\
  {L_{21}} = \frac{{{B_4} - {B_1}{B_3}/{B_0}}}{{\sqrt {{B_2} - B_1^2/{B_0}} }} \hfill \\ 
\end{gathered}
$$

Step 2:
$$
\begin{array}{l}
  {L_{22}}L_{22}^T 
  &= {B_5} - B_3^2/{B_0} - {\left( {{B_4} - {B_1}{B_3}/{B_0}} \right)^2}/\left( {{B_2} - B_1^2/{B_0}} \right) \hfill \\
   &= {B_5} - \frac{{B_3^2}}{{{B_0}}} - \frac{{{{\left( {{B_4}{B_0} - {B_1}{B_3}} \right)}^2}}}{{B_0^2}}\frac{{{B_0}}}{{{B_2}{B_0} - B_1^2}} \hfill \\
   &= {B_5} - \frac{{B_3^2}}{{{B_0}}} - \frac{{{{\left( {{B_4}{B_0} - {B_1}{B_3}} \right)}^2}}}{{{B_0}\left( {{B_2}{B_0} - B_1^2} \right)}} \hfill \\
   &= \frac{{{B_5}{B_0}\left( {{B_2}{B_0} - B_1^2} \right) - B_3^2\left( {{B_2}{B_0} - B_1^2} \right) - {{\left( {{B_4}{B_0} - {B_1}{B_3}} \right)}^2}}}{{{B_0}\left( {{B_2}{B_0} - B_1^2} \right)}} \hfill \\
   &= \frac{{{B_2}{B_5}B_0^2 - {B_0}{B_5}B_1^2 - {B_0}{B_2}B_3^2 + B_1^2B_3^2 - B_0^2B_4^2 - B_1^2B_3^2 + 2{B_0}{B_1}{B_3}{B_4}}}{{{B_0}\left( {{B_2}{B_0} - B_1^2} \right)}} \hfill \\
  & = \frac{{{B_2}{B_5}B_0^2 - {B_0}B_1^2{B_5} - {B_0}{B_2}B_3^2 - B_0^2B_4^2 + 2{B_0}{B_1}{B_3}{B_4}}}{{{B_0}\left( {{B_2}{B_0} - B_1^2} \right)}} \hfill \\
   &= \frac{{{B_2}{B_5} B_5 - B_1^2{B_5} - B_0^2B_4^2 + 2{B_1}{B_3}{B_4} - {B_2}B_3^2}}{{{B_2}{B_0} - B_1^2}} \hfill \\ 
\end{array}
$$
为了方便，我们记：
$$
\begin{array}{l}
  w = B_0{B_2}{B_5} - B_1^2{B_5} - B_0^2B_4^2 + 2{B_1}{B_3}{B_4} - {B_2}B_3^2 \hfill \\
  d = {B_2}{B_0} - B_1^2 \hfill \\ 
\end{array}
$$
Step 3：
$$
L_{22} = \begin{gathered}
\sqrt{\frac{w}{d}}
\end{gathered}
$$

因此最终Cholesky分解 $B=LL^T$：
$$
\begin{array}{*{20}{l}}
  L&{ = \left[ {\begin{array}{*{20}{c}}
  {\sqrt {{B_0}} }&0&0 \\ 
  {{B_1}/\sqrt {{B_0}} }&{\sqrt {{B_2} - B_1^2/{B_0}} }&0 \\ 
  {{B_3}/\sqrt {{B_0}} }&{\frac{{{B_4} - {B_1}{B_3}/{B_0}}}{{\sqrt {{B_2} - B_1^2/{B_0}} }}}&{\sqrt {\frac{w}{d}} } 
\end{array}} \right]} \\ 
  {}&{ = \left[ {\begin{array}{*{20}{c}}
  {\frac{{\sqrt \lambda  }}{\alpha }}&0&0 \\ 
  { - \frac{{\sqrt \lambda  \gamma }}{{\alpha \beta }}}&{\frac{{\sqrt \lambda  }}{\beta }}&0 \\ 
  {\frac{{\sqrt \lambda  \left( {\gamma {v_0} - \beta {\mu _0}} \right)}}{{\alpha \beta }}}&{ - \frac{{\sqrt \lambda  {v_0}}}{\beta }}&{\sqrt \lambda  } 
\end{array}} \right]}


\end{array}
$$
整理可得：
$$
\begin{array}{l}
  \lambda  &= w/d \hfill \\
  \alpha  &= \sqrt {\frac{\lambda }{{{B_0}}}}  \hfill \\
  \beta  &= \sqrt {\frac{{\lambda {B_0}}}{d}}  \hfill \\
  \gamma  &=  - {B_1}\sqrt {\frac{w}{{{B_0}{d^2}}}}  \hfill \\
  {v_0} &= \frac{{{B_1}{B_3} - {B_4}{B_0}}}{d} \hfill \\
  {u_0} &= \frac{{{B_4}{B_1} - {B_2}{B_3}}}{d} \hfill \\ 
\end{array}
$$

> 过程：
> $$
> \begin{array}{l}
>   \sqrt \lambda   = \sqrt {\frac{w}{d}}  \to \lambda  = w/d \hfill \\
>   \frac{{\sqrt \lambda  }}{\alpha } = \sqrt {{B_0}}  \leftrightarrow \alpha  = \sqrt {\frac{\lambda }{{{B_0}}}}  \hfill \\
>   \frac{{\sqrt \lambda  }}{\beta } = \sqrt {{B_2} - B_1^2/{B_0}}  \to \beta  = \sqrt \lambda  /\sqrt {\frac{{{B_0}{B_2} - B_1^2}}{{{B_0}}}}  = \sqrt {\frac{{\lambda {B_0}}}{d}}  \hfill \\
>    - \frac{{\sqrt \lambda  \gamma }}{{\alpha \beta }} = {B_1}/\sqrt {{B_0}}  \to \gamma  =  - \frac{{{B_1}}}{{\sqrt {{B_0}} }}\frac{{\alpha \beta }}{{\sqrt \lambda  }} =  - \frac{{{B_1}}}{{\sqrt {{B_0}} }}\sqrt {\frac{\lambda }{{{B_0}}}} \sqrt {\frac{{\lambda {B_0}}}{d}} \frac{1}{{\sqrt \lambda  }} =  - {B_1}\sqrt {\frac{w}{{{B_0}{d^2}}}}  \hfill \\
>    - \frac{{\sqrt \lambda  {v_0}}}{\beta } = \frac{{{B_4} - {B_1}{B_3}/{B_0}}}{{\sqrt {{B_2} - B_1^2/{B_0}} }} =  \to {v_0} =  - \frac{{{B_4}{B_0} - {B_1}{B_3}}}{{{B_0}}}\sqrt {\frac{{{B_0}}}{{{B_2}{B_0} - B_1^2}}} \frac{\beta }{{\sqrt \lambda  }} =  - \frac{{{B_4}{B_0} - {B_1}{B_3}}}{{{B_0}}}\sqrt {\frac{{{B_0}}}{d}} \sqrt {\frac{w}{d}\frac{{{B_0}}}{d}} \sqrt {\frac{d}{w}}  = \frac{{{B_1}{B_3} - {B_4}{B_0}}}{d} \hfill \\
>   \frac{{\sqrt \lambda  \left( {\gamma {v_0} - \beta {\mu _0}} \right)}}{{\alpha \beta }} = {B_3}/\sqrt {{B_0}}  \to {\mu _0} = \left( {\frac{{\gamma {v_0}}}{\beta } - \frac{{\alpha {B_3}}}{{\sqrt \lambda  \sqrt {{B_0}} }}} \right) =  - \frac{{\left( {{B_1}{B_3} - {B_4}{B_0}} \right)}}{d}{B_1}\sqrt {\frac{\lambda }{{{B_0}d}}} \sqrt {\frac{d}{{\lambda {B_0}}}}  - \sqrt {\frac{\lambda }{{{B_0}}}} \frac{{{B_3}}}{{\sqrt \lambda  \sqrt {{B_0}} }} \hfill \\
>    = \frac{{\left( {{B_4}{B_0} - {B_1}{B_3}} \right)}}{d}\frac{{{B_1}}}{{{B_0}}} - \frac{{{B_3}}}{{{B_0}}} = \frac{{{B_4}{B_0}{B_1} - B_1^2{B_3} - {B_3}\left( {{B_2}{B_0} - B_1^2} \right)}}{{d{B_0}}} = \frac{{{B_4}{B_0}{B_1} - B_1^2{B_3} - {B_2}{B_0}{B_3} + {B_3}B_1^2}}{{d{B_0}}} = \frac{{{B_4}{B_1} - {B_2}{B_3}}}{d} \hfill \\ 
> \end{array}
> $$

获得这些参数即可得到相机的内参矩阵。

## 4.3 求解外参矩阵

> 对于同一个相机，相机内参取决于相机的结构、光学参数，无论标定板与相机之间的位置关系如何变化，相机的内参矩阵都不会发生改变。这也是我们可以利用不同位姿的标定板图片求解相机内参 $A$ 的原因。

之前的方程（重新定义 $\lambda$）：
$$
 A\left[ {\begin{array}{*{20}{c}}
{{R_1}}&{{R_2}}&t
\end{array}} \right] = \lambda H
$$
于是有：
$$
\begin{gathered}
  {R_1} = \lambda {A^{ - 1}}{h_1} \hfill \\
  {R_2} = \lambda {A^{ - 1}}{h_2} \hfill \\
  t = \lambda {A^{ - 1}}{h_3} \hfill \\ 
\end{gathered}
$$
旋转矩阵是[正交矩阵](https://baike.baidu.com/item/%E6%AD%A3%E4%BA%A4%E7%9F%A9%E9%98%B5/407284?fr=aladdin)，每一列都是单位范数向量，因此对上述公式取 $l2$ 范数，有：
$$
\lambda  = \frac{1}{{\left\| {{A^{ - 1}}{h_1}} \right\|}} = \frac{2}{{\left\| {{A^{ - 1}}{h_1}} \right\|}}
$$
由于张正友标定法将世界坐标系原点选取在棋盘格上，棋盘格上任意一点的物理坐标：$Z=0$，因此并没有约束可以将 $R_3$ 直接求出，但是 $R_3$ 要使得 $R$ 为单位正交，因此可以通过构建[叉乘](https://mp.weixin.qq.com/s/WsUv6vD4QUywK8dZXDvxZw)（生成的向量正交于 $R_1、R_2$）：
$$
R_3 = R_1 \times R_2
$$
$R_3$ 与 $R_1、R_2$ 均正交，通过最终的缩放，即可得到单位正交的 $R_3$，进而得到最终的旋转矩阵 $R$。

---

通过解线性方程组或者采用优化方法得到的旋转矩阵的数值解，往往没有考虑到正交约束，会得到一个存在误差的近似旋转矩阵![R_{0}](https://private.codecogs.com/gif.latex?R_%7B0%7D)，也就是说这个矩阵并不是一个严格正交的标准正交矩阵，不满足$A^{T} = A^{-1}$因此，需要将矩阵近似为最接近的正交矩阵。

1. 对旋转矩阵$R$ 进行SVD分解：
   $$
   R_0 = U \sum V^T
   $$

2. 奇异值矩阵用单位矩阵替代：
   $$
   R=UV^T
   $$

---

另外，在进行相机畸变估计和非线性优化之前，我们先看下它的重投影误差。回顾针孔相机公式：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  \alpha &\gamma &{{u_0}} \\ 
  0&\beta &{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{R_{3 \times 3}}}&{{T_{3 \times 1}}} 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$
即：
$$
\left[ {\begin{array}{*{20}{c}}
  {u'} \\ 
  {v'} 
\end{array}} \right] = {\hom ^{ - 1}}\left( {P\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]} \right)
$$
而重投影误差：
$$
e = \frac{1}{{2N}}{\sum\limits_{i = 1}^N {\left\| {\left( {u,v} \right) - \left( {u',v'} \right)} \right\|} _2}
$$

## 4.4 估计相机畸变

> 目前为止，我们还没有考虑相机的畸变情况。在原始的张正友标定方法中，仅考虑了畸变模型中影响较大的径向畸变（我们先考虑简单的情况，更多的畸变系数估计可以自己增加，在Matlab中默认也仅考虑二阶畸变，另外增加系数也不一定合适）。

考虑光线传播过程，物点从世界坐标系转换到相机坐标系：

$$
\left[ {\begin{array}{*{20}{c}}
  {{X_c}} \\ 
  {{Y_c}} \\ 
  {{Z_c}} \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  R&t 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_w}} \\ 
  {{Y_w}} \\ 
  {{Z_w}} \\ 
  1 
\end{array}} \right]
$$
我们所有畸变校正都在归一化平面，而归一化平面距离原点的距离为1，即：
$$
\left[ {\begin{array}{*{20}{c}}
  {{X_c}/{Z_c}} \\ 
  {Y_c/{Z_c}} \\ 
  1 \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  R&t 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_w}} \\ 
  {{Y_w}} \\ 
  {{Z_w}} \\ 
  1 
\end{array}} \right]/{Z_c}
$$
对于棋盘格来说，它的计算结果和下式是一样的（$Z_w = 0$）：
$$
\left[ {\begin{array}{*{20}{c}}
  {{X_c}/{Z_c}} \\ 
  {{Y_c}/{Z_c}} \\ 
  1 \\ 
  1 
\end{array}} \right] = {\hom ^{ - 1}}\left( {\left[ {\begin{array}{*{20}{c}}
  R&t 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_w}} \\ 
  {{Y_w}} \\ 
  0 \\ 
  1 
\end{array}} \right]} \right)
$$
根据之前的建模，径向畸变的公式如下：
$$
\begin{array}{l}
  \tilde x = \overline x \left( {1 + D\left( {{r_{i,j}},{\mathbf{k}}} \right)} \right) \hfill = {\bar{x}}(1 + k_0 r^2 + k_1r^4)
 \label{dist}
\end{array}
$$
其中：

- $\bar{x}$ ：无畸变的归一化图像坐标系
- $ \tilde x $：畸变的归一化图像坐标系

归一化图像坐标系与像素坐标系之间的转换关系如下：
$$
\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  \alpha &\gamma &{{u_0}} \\ 
  0&\beta &{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  x \\ 
  y \\ 
  1 
\end{array}} \right]
$$
由于仅计算初值，不考虑 $u,v$ 轴的夹角，显然有：
$$
\begin{array}{*{20}{c}}
  {u = \alpha x + {u_0}} \\ 
  {v = \beta y + {v_0}} 
\end{array} \to \begin{array}{*{20}{c}}
  {x = \left( {u - {u_0}} \right)/\alpha } \\ 
  {y = \left( {v - {v_0}} \right)/\beta } 
\end{array}
$$
那么公式 $\ref{dist}$ 显然也可以改写：
$$
{{\tilde u}_{i,j}} - {u_0} = \left( {{{\bar u}_{i,j}} - {u_0}} \right)\left( {1 + D\left( {{r_{i,j}},{\mathbf{k}}} \right)} \right) \hfill \\
$$

- ${{{\bar u}_{i,j}}}$：无畸变的像素坐标点
- ${\tilde u_{u,j}}$：畸变后的像素坐标点
- $u_0$：相机主点，由于在中心，因此无畸变

于是上式可以写为：
$$
\begin{gathered}
  {{\tilde u}_{i,j}} - {{\bar u}_{i,j}} = \underbrace {\left( {{{\bar u}_{i,j}} - {u_0}} \right)D\left( {{r_{i,j}},{\mathbf{k}}} \right)}_{{d_{ij}}} \hfill \\ 
\end{gathered}
$$
在该式中：

-  $\tilde {u}_{i,j}$：畸变后的像素点，即检测到的角点像素坐标
- $\bar{u}_ {i,j}$ ：根据相机参数计算的重投影像素坐标

于是构成齐次方程：
$$
\begin{gathered}
  \left( {{{\overline u }_{i,j}} - {u_0}} \right)r_{i,j}^2 \cdot {k_0} + \left( {{{\overline u }_{i,j}} - {u_0}} \right)r_{i,j}^4{k_1} = {{\tilde u}_{i,j}} - {\overline u _{i,j}} \hfill \\
  \left( {{{\overline v }_{i,j}} - {v_0}} \right)r_{i,j}^2 \cdot {k_0} + \left( {{{\overline v }_{i,j}} - {v_0}} \right)r_{i,j}^4{k_1} = {\widetilde v_{i,j}} - {\overline v _{i,j}} \hfill \\ 
\end{gathered} 
$$
构建方程组：
$$
\left[ \begin{gathered}
  \begin{array}{*{20}{c}}
  {\left( {{{\overline u }_{1,1}} - {u_0}} \right)r_{1,1}^2}&{\left( {{{\overline u }_{1,1}} - {u_0}} \right)r_{1,1}^4} \\ 
  {\left( {{{\overline v }_{1,1}} - {v_0}} \right)r_{1,1}^2}&{\left( {{{\overline v }_{1,1}} - {v_0}} \right)r_{1,1}^4} \\ 
   \vdots & \vdots  \\ 
  {\left( {{{\overline u }_{i,j}} - {u_0}} \right)r_{i,j}^2}&{\left( {{{\overline u }_{i,j}} - {u_0}} \right)r_{i,j}^4} \\ 
  {\left( {{{\overline v }_{i,j}} - {v_0}} \right)r_{i,j}^2}&{\left( {{{\overline v }_{i,j}} - {v_0}} \right)r_{i,j}^4} \\ 
   \vdots & \vdots  \\ 
  {\left( {{{\overline u }_{m,n}} - {u_0}} \right)r_{m,n}^2}&{\left( {{{\overline u }_{m,n}} - {u_0}} \right)r_{m,n}^4} 
\end{array} \hfill \\
  \begin{array}{*{20}{c}}
  {\left( {{{\overline v }_{m,n}} - {v_0}} \right)r_{m,n}^2}&{\left( {{{\overline v }_{m,n}} - {u_0}} \right)r_{m,n}^4} 
\end{array} \hfill \\ 
\end{gathered}  \right]\left[ {\begin{array}{*{20}{c}}
  {{k_0}} \\ 
  {{k_1}} 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {{{\tilde u}_{1,1}} - {{\overline u }_{1,1}}} \\ 
  {{{\widetilde v}_{1,1}} - {{\overline v }_{1,1}}} \\ 
   \vdots  \\ 
  {{{\tilde u}_{i,j}} - {{\overline u }_{i,j}}} \\ 
  {{{\widetilde v}_{i,j}} - {{\overline v }_{i,j}}} \\ 
   \vdots  \\ 
  {{{\tilde u}_{m,n}} - {{\overline u }_{m,n}}} \\ 
  {{{\widetilde v}_{m,n}} - {{\overline v }_{m,n}}} 
\end{array}} \right]
$$
将它们进行重新排序，并进行标记：
$$
\underbrace {\left[ {\begin{array}{*{20}{c}}
  {\left( {{{\bar u}_{1,1}} - {u_0}} \right)r_{1,1}^2}&{\left( {{{\bar u}_{1,1}} - {u_0}} \right)r_{1,1}^4} \\ 
   \vdots & \vdots  \\ 
  {\left( {{{\bar u}_{m,n}} - {u_0}} \right)r_{m,n}^2}&{\left( {{{\bar u}_{m,n}} - {u_0}} \right)r_{m,n}^4} \\ 
\hline
  {\left( {{{\bar v}_{1,1}} - {v_0}} \right)r_{1,1}^2}&{\left( {{{\bar u}_{1,1}} - {u_0}} \right)r_{1,1}^4} \\ 
   \vdots & \vdots  \\ 
  {\underbrace {\left( {{{\bar u}_{m,n}} - {u_0}} \right)}_pr_{m,n}^2}&{\left( {{{\bar u}_{m,n}} - {u_0}} \right)r_{m,n}^4} 
\end{array}} \right]}_D\left[ {\begin{array}{*{20}{c}}
  {{k_0}} \\ 
  {{k_1}} 
\end{array}} \right] = \underbrace {\left[ {\begin{array}{*{20}{c}}
  {{{\tilde u}_{1,1}} - {{\bar u}_{1,1}}} \\ 
   \vdots  \\ 
  {{{\tilde u}_{m,n}} - {{\bar u}_{m,n}}} \\ 
\hline
  {{{\widetilde v}_{1,1}} - {{\bar v}_{1,1}}} \\ 
   \vdots  \\ 
  {{{\widetilde v}_{m,n}} - {{\bar v}_{m,n}}} 
\end{array}} \right]}_d
$$
依然使用SVD分解方程，也可以使用伪逆求解，两者的差距并不大。

# 05 非线性优化

> 前面的线性部分，其实只是用于初值估计，它并没有考虑最终的效果，要获得准确的相机参数，还是需要进行非线性优化。

假设我们有 $M$ 副标定图片，每副标定图片上有 $N$ 个角点，最终我们需要优化内部参数：

$$
{\mathbf{a}} = {\left[ {\underbrace {\alpha ,\beta ,\gamma ,{u_0},{v_0}}_A,\underbrace {{k_0},{k_1}}_k} \right]^T}
$$
其中：

- $\alpha, \beta, \gamma, u_0,v_0$：是从相机内参 $A$ 中得到
- $k_0,k_1$：畸变参数获得

需要优化的外参：
$$
{{\bf{w}}_i} = {\left[ {\underbrace {{\rho _{x,i}},{\rho _{y,i}},{\rho _{z,i}}}_{{R_i}},\underbrace {{t_{x,i}},{t_{y,i}},{t_{z,i}}}_{{t_i}}} \right]^T}， \quad (i=1,2,...,N)
$$
其中：

- $\rho_i$：是旋转向量，从旋转矩阵获得
- $t_i$：平移向量

因此定义要优化的参数：
$$
p = (\bf{a, w_1, w_2,...w_M})
$$

假定我们观察到的像素点为：${{u}}_{ij}$，而根据模型计算的的像素点为：${{\tilde{u}}} _{i,j}$（根据估计的参数计算的投影点），则重投影误差为：
$$
\begin{array}{l}
  E 
  &= \sum\limits_{i = 1}^M {\sum\limits_{j = 1}^N {\left\| {{u_{i,j}} - {{\tilde u}_{i,j}}} \right\|} }  \hfill \\
   &= \sum\limits_{i = 1}^M {\sum\limits_{j = 1}^N {\left\| {{u_{i,j}} - P\left( {a,{w_i},{X_j}} \right)} \right\|} }  \hfill \\ 
\end{array}
$$
我们来看 $P$ 的具体形式（因为之后需要求偏导）：

1. 从世界坐标系转化到相机坐标系：
   $$
   \left[ {\begin{array}{*{20}{c}}
     {{X_c}} \\ 
     {{Y_c}} \\ 
     {{Z_c}} \\ 
     1 
   \end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
     {{R_{3 \times 3}}}&{{T_{3 \times 1}}} \\ 
     0&1 
   \end{array}} \right]\left[ {\begin{array}{*{20}{c}}
     {{X_w}} \\ 
     {{Y_w}} \\ 
     {{Z_w}} \\ 
     1 
   \end{array}} \right]
   $$

2. 相机坐标系到归一化坐标系（距离光心的$Z$ 方向距离为1）：
   $$
   \left[ {\begin{array}{*{20}{c}}
     {{x}} \\ 
     {{y}} \\ 
     1 \\ 
     1 
   \end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
     {{X_c}/{Z_c}} \\ 
     {{Y_c}/{Z_c}} \\ 
     1 \\ 
     1 
   \end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
     {{R_{3 \times 3}}}&{{T_{3 \times 1}}} \\ 
     0&1 
   \end{array}} \right]\left[ {\begin{array}{*{20}{c}}
     {{X_w}} \\ 
     {{Y_w}} \\ 
     {{Z_w}} \\ 
     1 
   \end{array}} \right]/{Z_c}
   $$

3. 发生畸变：
   $$
   \begin{gathered}
     \tilde x = x\left( {1 + {k_0}{r^2} + {k_1}{r^4}} \right) \hfill \\
     \tilde y = y\left( {1 + {k_0}{r^2} + {k_1}{r^4}} \right) \hfill \\ 
   \end{gathered} 
   $$

4. 转换到像素坐标系：
   $$
   \left[ {\begin{array}{*{20}{c}}
     {\tilde u} \\ 
     {\tilde v} \\ 
     1 
   \end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
     \alpha &\gamma &{{u_0}} \\ 
     0&\beta &{{v_0}} \\ 
     0&0&1 
   \end{array}} \right]\left[ {\begin{array}{*{20}{c}}
     {\tilde x} \\ 
     {\tilde y} \\ 
     1 
   \end{array}} \right]
   $$

在写代码时候，同样的我们将 $X$ 的放前面，$Y$ 放后面，方便直接赋值。类似的，我们可以构建方程组：
$$
\left\{ {\begin{array}{*{20}{c}}
  {{f_1}\left( {{X_{{W_1}}}} \right) = {{\widetilde u}_1}} \\ 
   \vdots  \\ 
  {{f_{M \times N}}\left( {{X_{{W_{M \times N}}}}} \right) = {{\widetilde u}_{M \times N}}} \\ 
\hline
  {{g_1}\left( {{Y_{{W_1}}}} \right) = {{\widetilde v}_1}} \\ 
   \vdots  \\ 
  {{g_{M \times N}}\left( {{Y_{{W_{M \times N}}}}} \right) = {{\widetilde v}_{M \times N}}} 
\end{array}} \right.
$$

重投影误差：https://blog.csdn.net/qq_32998593/article/details/113063216

# 06 移除图像畸变

给定一幅真实图像，我们可以通过几何变换，移除镜头的畸变，表示如下：
$$
u' = T\left( u \right)
$$
其中：

- $u$：真实图像（存在畸变）
- $u'$：校正后图像（无畸变）

这里 $T$ 是2D几何变换，依赖于相机内参（外参在这里没有用了），我们记：
$$
T:I \to I'
$$
反过来，同样的有：
$$
T ^ {-1}:I' \to I
$$
直接求逆即可，不需要去翻转径向畸变函数。相关的变化如下：

1. 从校正后的传感器点：$(u',v')$ 向后移动投影链，通过反转相机内参 A，得到了归一化图像平面上对应的点：
   $$
   \left[ {\begin{array}{*{20}{c}}
     {x'} \\ 
     {y'} \\ 
     1 
   \end{array}} \right] = {\underbrace {\left[ {\begin{array}{*{20}{c}}
     \alpha &\gamma &{{u_0}} \\ 
     0&\beta &{{v_0}} \\ 
     0&0&1 
   \end{array}} \right]}_A}^{ - 1}\left[ {\begin{array}{*{20}{c}}
     {u'} \\ 
     {v'} \\ 
     1 
   \end{array}} \right] = \underbrace {\left[ {\begin{array}{*{20}{c}}
     {\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{{v_0}\gamma  - {\mu _0}\beta }}{{\alpha \beta }}} \\ 
     0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }} \\ 
     0&0&1 
   \end{array}} \right]}_{{A^{ - 1}}}\left[ {\begin{array}{*{20}{c}}
     {u'} \\ 
     {v'} \\ 
     
   \end{array}} \right]
   $$
   由于对于 $I'$ 来说并不存在畸变，因此 $x'$ 被认为在归一化平面没有畸变的位置。

2. 前向传播，获得畸变后的坐标：
   $$
   \widetilde x = warp\left( {x',k} \right) = x'(1 + D)
   $$

3. 最终应用相机内参：
   $$
   u = A \widetilde x
   $$
   该坐标即我们观察到的坐标，存在畸变。

因此总结来说，从校正后的图片 $I'$ 获得真实畸变的图片的过程可以写作：
$$
u = T^{-1} (u') = A  \cdot warp(A^ {-1} \cdot u')
$$
于是反过来，我们就可以获得无畸变的图片，具体步骤如下：

1. 对于所有图像坐标：$u'$ 在图 $I'$ 中做
2. 计算相应的 $u= T^{-1} (u')$
3. 插值：$interpolate(I, u)$
4. 插值再反向计算

由于校正的实现较为复杂，直接调用API实现。































































































