[toc]

> 参考链接：
>
> 1. [相机标定之张正友标定法数学原理详解（含python源码）](https://zhuanlan.zhihu.com/p/94244568)
> 2. [张正友标定法Python详细实现](https://github.com/goldbema/CameraCalibration)
> 3. [单应矩阵的作用](https://zhuanlan.zhihu.com/p/427190988)

# 01 最小二乘问题

## 1.1 特征值分解

设 $A$ 为 $n$ 阶方阵，若存在数 $\lambda$ 和非零向量 $v$，使得：
$$
A v = \lambda v (v \ne 0)
$$
则称：

- $\lambda$ ：矩阵 $A$ 的一个**特征值**
- $v$ ：矩阵 $A$ 的对应于特征值 $\lambda$ 的**特征向量**。

> 补充1：特征值、特征向量求解
>
> 例：求解三阶实矩阵 $$





那么求解出特征值、特征向量有什么用呢？





## 1.2 奇异值分解



## 1.3 最小二乘法问题



## 1.4 最小二乘SVD法



## 1.5 总体最小二乘法



## 3.1 最小二乘法的SVD解法

> **矩阵分解意义**：当我们求解一个线性方程组 $Ax=b$ 的时候，其解通常可以表示为：$x = A^{-1}b$（方阵且非奇义），这个矩阵通常是非常大的，因此非常耗费时间。通常会采用诸如：[LU分解、QR分解 Chole sky分解、Schur分解、奇异分解](https://zhuanlan.zhihu.com/p/84210687)等加速运算、节约存储空间。

### (1) 特征值和特征向量

设 $A$ 为 $n$ 阶方阵，若存在数 $\lambda$ 和非零向量 $x$，使得：
$$
Ax = \lambda x (x \ne 0)
$$
则称 $\lambda$ 是矩阵 $A$ 的一个**特征值**，$x$ 是矩阵 $A$ 的对应于特征值 $\lambda$ 的**特征向量**。

> 求解出特征值、特征向量有什么好处呢？

如果我们求出了矩阵 $A$ 的 $n$ 个特征值 $\lambda_1 \le \lambda_2 \le ... \le \lambda_n$，以及这 $n$ 个特征值对应的特征向量 $w_1, w_2,...,w_n$，如果这 $n$ 个特征向量线性无关（矩阵 $A$ 满秩），那么矩阵 $A$ 就可以用下面的特征分解表示：
$$
A = W S {{W^{ - 1}}}
$$
其中：

- $W$：$n$ 个特征向量组成的 $n \times n$ 维矩阵
- $\sum$：$n$ 个特征值作为主对角线的 $n \times n$ 维对角矩阵

> 证明：
>
> 

因为取逆的运算太耗费时间，一般我们会将 $W$ 的这 $n$ 个**特征向量标准化**，即满足：${\left\| {{w_i}} \right\|_2} = 1$，$w_i^Tw=1$。此时 $W$ 的 $n$ 个特征向量为标准正交基，满足：$W^TW=I$，即$W^T=W^{-1}$，也就是 $W $为酉矩阵（转置的运算远远小于求逆）。
$$
A = W S W^T
$$

> 这样分解的目的是更方便我们求解一些线性方程，这在SVD奇异值应用中我们会说。这里要求矩阵 $A$ 为方阵，但如果不是方阵呢？可以用SVD奇异值分解。

### (2) SVD[奇异值](https://zhuanlan.zhihu.com/p/261308315)定义

假设矩阵 $A$ 是一个 $m \times n $ 的矩阵，那么定义矩阵 $A$ 的SVD为：
$$
A = U S V^T
$$
其中：

- $U$：$m \times m$ 矩阵，酉矩阵，$U^TU=I$
- $\sum$：$m \times n$ 矩阵（除了主对角线上的元素以外全为0），主对角线上的每个元素都称为奇异值
- $V$：$n\times n$ 矩阵，酉矩阵，$V^TV=I$

如果将 $A$ 的转置和 $A$ 做矩阵乘法，这样会得到：$n \times n$ 的方阵 $A^TA$ 是方阵，那么我们进行特征值分解，即可得到特征值和特征向量：
$$
\left( {{A^T}A} \right){v_i} = {\lambda _i}{v_i}
$$
这样我们就可以得到 $A^T A$ 的 $n$ 个特征值 $v$，将 $A^T A$ 的所有特征向量组成 $n \times n$ 的矩阵 $V$，其中的向量称为右奇异向量。相类似的，我们可以求出左奇异矩阵 $U$：
$$
\left( {A{A^T}} \right){u_i} = {\lambda _i}{u_i}
$$
由于 $\sum$ 除了对角线上是奇异值，其他位置都是0，我们注意到：
$$
\begin{array}{c}
A = U\sum {{V^T}}  \to AV = U\sum {{V^T}} V \to AV = U\sum {} \\
 \downarrow \\
A{v_i} = {\sigma _i}{u_i} \to {\sigma _i} = A{v_i}/{u_i}
\end{array}
$$
求出奇异值矩阵 $\sum$ 。也可以用过：$\sigma_i=\sqrt{\lambda_i}$ 来计算奇异值。奇异值的数量与 $r$ 矩阵的秩相关。

> **证明：**
> $$
> A = U\sum {{V^T} \to {A^T} = V\sum {^T{U^T}} }  \to V\sum {^T} {U^T}U\sum {{V^T} = } V\sum {{V^T}}
> $$

### (3) 计算案例

矩阵 $A$ 定义为：
$$
A = \left[ {\begin{array}{*{20}{c}}
0&1\\
1&1\\
1&0
\end{array}} \right]
$$
首先求出：$A^TA$和 $A A^T$：
$$
\begin{array}{l}
{A^T}A = \left[ {\begin{array}{*{20}{c}}
0&1&1\\
1&1&0
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
0&1\\
1&1\\
1&0
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
2&1\\
1&2
\end{array}} \right]\\
A{A^T} = \left[ {\begin{array}{*{20}{c}}
0&1\\
1&1\\
1&0
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
0&1&1\\
1&1&0
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
1&1&0\\
1&2&1\\
0&1&1
\end{array}} \right]
\end{array}
$$
进而求出 $A^T A$ 的特征值和特征向量（根据特征值从大到小排列）：
$$
\begin{array}{l}
{\lambda _1} = 3,{v_1} = \left[ {\begin{array}{*{20}{c}}
{1/\sqrt 2 }\\
{1/\sqrt 2 }
\end{array}} \right], \quad 
{\lambda _2} = 1,{v_2} = \left[ {\begin{array}{*{20}{c}}
{ - 1/\sqrt 2 }\\
{1/\sqrt 2 }
\end{array}} \right]
\end{array}
$$
接着求出 $AA^T$ 的特征值和特征向量：
$$
{\lambda _1} = 3,{u_1} = \left[ {\begin{array}{*{20}{c}}
{1/\sqrt 6 }\\
{2/\sqrt 6 }\\
{1/\sqrt 6 }
\end{array}} \right], \quad

{\lambda _2} = 1,{u_2} = \left[ {\begin{array}{*{20}{c}}
{1/\sqrt 2 }\\
0\\
{ - 1/\sqrt 2 }
\end{array}} \right], \quad
{\lambda _3} = 0,{u_3} = \left[ {\begin{array}{*{20}{c}}
{1/\sqrt 3 }\\
{ - 1/\sqrt 3 }\\
{1/\sqrt 3 }
\end{array}} \right]
$$
利用 $A v_i = \sigma _ i u_i$：
$$
\begin{array}{}
\left[ {\begin{array}{*{20}{c}}
0&1\\
1&1\\
1&0
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{1/\sqrt 2 }\\
{1/\sqrt 2 }
\end{array}} \right] = {\sigma _1}\left[ {\begin{array}{*{20}{c}}
{1/\sqrt 6 }\\
{2/\sqrt 6 }\\
{1/\sqrt 6 }
\end{array}} \right] \to {\sigma _1} = \sqrt 3 \\
\left[ {\begin{array}{*{20}{c}}
0&1\\
1&1\\
1&0
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{ - 1/\sqrt 2 }\\
{1/\sqrt 2 }
\end{array}} \right] = {\sigma _2}\left[ {\begin{array}{*{20}{c}}
{1/\sqrt 2 }\\
0\\
{ - 1/\sqrt 2 }
\end{array}} \right] \to {\sigma _2} = 1
\end{array}
$$
可以验证：直接利用：$\sigma_i = \sqrt{ \lambda _ i}$ 进行求解，值是一样的。于是最终奇异值分解：
$$
A = U\sum {{V^T}}  = \left[ {\begin{array}{*{20}{c}}
{1/\sqrt 6 }&{1/\sqrt 2 }&{1/\sqrt 3 }\\
{2/\sqrt 6 }&0&{ - 1/\sqrt 3 }\\
{1/\sqrt 6 }&{ - 1/\sqrt 2 }&{1/\sqrt 3 }
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{\sqrt 3 }&0\\
0&1\\
0&0
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{1/\sqrt 2 }&{1/\sqrt 2 }\\
{ - 1/\sqrt 2 }&{1/\sqrt 2 }
\end{array}} \right]
$$

### (4) 解最小二乘方程

最小二乘问题：
$$
J(x)=\min \left\| {Ax - b} \right\|_2^2 \\A \in {\mathbb{R}_{m \times n}},x \in {\mathbb{R}_{n \times 1}},b \in {\mathbb{R}_{m \times 1}}
$$
$m$ 个方程求解 $n$ 个未知数，有三种情况：

- $m=n$，且 $A$ 为非奇异值，则有唯一解：$x= A^{-1} b$
- $m > n$，约束的个数大于未知数个数，称为超定问题
- $m < n$，欠定问题

通常我们遇到的都是超定问题，此时 $Ax = b$ 不存在解，转而求最小二乘问题。$J(x)$ 是[凸函数](https://blog.csdn.net/jgj123321/article/details/105945705/)（二阶导数非负），我们令一阶导数为0，可以得到：
$$
A^TAx-A^Tb=0
$$
进而方程的解：
$$
x=(A^TA)^{-1}A^Tb
$$



> 正交矩阵是一个方阵，它的逆矩阵等于它的转置，即：$Q^{-1}=Q^T$，它的每一列为标准正交向量，列的模长为1，即：$q_i^T{q_j} = \left\{ {\begin{array}{*{20}{c}}
> {1,i = j} \\ 
> {0,i \ne j} 
> \end{array}} \right.$，并且具有“模长不变性”：$||Qx||=||x||$，它的转置依然是正交矩阵。

给定矩阵 $A \in {\mathbb{R}_{m \times n}}$ ，进行奇异值分解，根据矩阵 $U$ 和 $V$ 的正交性（酉矩阵，例如$V^TV=I$），有：
$$
\left\| {Ax - b} \right\|_2^2 = \left\| {{U^T}\left( {Ax - b} \right)} \right\|_2^2 = \left\| {{U^T}U\sum {{V^T}} x - {U^T}b} \right\|_2^2 = \left\| {\sum {{V^T}} x - {U^T}b} \right\|_2^2
$$
令 $z=V^Tx$，则有：
$$
\left\| {Ax - b} \right\|_2^2 = \left\| {\sum {{V^T}x}  - {U^T}b} \right\|_2^2 = \sum\limits_{i = 1}^r {{{\left( {{\sigma _i}{z_i} - u_i^Tb} \right)}^2} + \sum\limits_{i = r + 1}^m {{{\left( {u_i^Tb} \right)}^2}} }
$$
显然，后面式子恒大于0，当前仅当：$\sigma_iz_i=u_i ^ T b$ 时，该式子最小，因此：
$$
{z_i} = \left\{ {\begin{array}{*{20}{c}}
  {\frac{{u_i^Tb}}{{{\sigma _i}}},i = 1,...,r} \\ 
  {0,i = r + 1,...,n} 
\end{array}} \right.
$$
最终 $x=Vz$ 求解出最合适的 $x$ 值，该方法不需要求逆，计算量更小，可以处理 $A^T A$ 为不可逆的情况。



## 3.2 非线性优化





## 3.3 光束法平差

### (1) 重投影误差

| <img src="https://img-blog.csdnimg.cn/692e6118f95c46c297fc31ba6385a6af.jpg?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCR5p2w5b6I5biF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述" style="zoom: 50%;" /> |
| :----------------------------------------------------------: |
|                     图 重投影误差示意图                      |

光束法平差实际是在**[最小化重投影误差](https://blog.csdn.net/weixin_49804978/article/details/121922128)**，我们先来说什么是重投影误差：

1. **初投影**：相机拍照时实际的三维空间点投影到像素平面，经过角点检测，我们可以获得角点的像素坐标（映射）
2. **标定内参**：根据这些角点的像素坐标以及相应世界坐标（标定板上的角点世界坐标都是已知），计算获得相机内参、外参矩阵
3. **重投影**：将理论上的三维空间点，根据相机内参、外参重新投影到成像平面（$$）

初投影（映射）和重投影之间的像素差值，即为重投影误差。

### (2) 非线性优化





# 02 相机模型

## 1.1 四大坐标系

最为常用的针孔相机模型是由小孔成像模型演变过来的（因此很多高精度重建算法中我们希望光圈尽可能下）：

| <img src="https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505105420925.png" alt="image-20220505105420925" style="zoom:67%;" /> | ![image-20220505112035782](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505112035782.png) |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|                    **图 1 小孔成像模型**                     |                **图2 针孔相机模型（未翻转）**                |

其中：$P$：物点、$P'$：像点、$f$：焦距、$O_c$：光心、$O'xy$：成像平面（CCD）。将其进行翻转即实际的针孔相机模型（避免了上下翻转，电子实现），它由四大坐标系构成：世界坐标系、相机坐标系、

| ![image-20220505112424388](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505112424388.png) |
| :----------------------------------------------------------: |
|               **图3 针孔相机模型：四大坐标系**               |

### (1) 世界坐标系->相机坐标系

| <img src="https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505112251643.png" alt="image-20220505112251643" style="zoom:80%;" /> |
| :----------------------------------------------------------: |
|               **图4 世界坐标系 -> 相机坐标系**               |

> **世界坐标系（3D）**：以外界某个参考点建立的坐标系，单位为 $mm$，或者 $m$。
>
> **相机坐标系（3D）**：以相机光心建立的坐标系，其 $z$ 轴指向相机的正前方。

假设物点在世界坐标系下的坐标为：$P=[X_W,Y_W,Z_W]$，那么转换到相机坐标系下坐标：$P=[X_C,Y_C,Z_C]^T$ 的变换如下：
$$
\left[ {\begin{array}{*{20}{c}}
  {{X_C}} \\ 
  {{Y_C}} \\ 
  {{Z_C}} 
\end{array}} \right] = R_{3\times 3}\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} 
\end{array}} \right] + T_{3 \times 1} \Rightarrow \left[ {\begin{array}{*{20}{c}}
  {{X_C}} \\ 
  {{Y_C}} \\ 
  {{Z_C}} \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  R_{3 \times 3}&T_{3 \times 1} \\ 
  0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$

> 注：齐次坐标系的使用在于统一旋转和平移。

### (2) 相机坐标系->图像坐标系

| ![image-20220505112818640](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505112818640.png) |
| :----------------------------------------------------------: |
|                **图5 相机坐标系->图像坐标系**                |

> **图像坐标系（2D）**：以光心在成像平面的投影为原点建立的坐标系，称为图像坐标系。

将像点 $p$ 记为：$p=[x,y]^T$，根据简单的相似三角形关系，很容易有：
$$
\frac{{{X_c}}}{x} = \frac{{{Z_c}}}{f} = \frac{{{Y_c}}}{y} \Rightarrow x = f\frac{{{X_c}}}{{{Z_c}}},y = f\frac{{{Y_c}}}{{{Z_c}}}
$$
与之前公式统一，写为齐次形式：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  x \\ 
  y \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  f&0&0&0 \\ 
  0&f&0&0 \\ 
  0&0&1&0 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_C}} \\ 
  {{Y_C}} \\ 
  {{Z_C}} \\ 
  1 
\end{array}} \right]
$$

### (3) 图像坐标系->像素坐标系

> **像素坐标系（2D）**：我们最终用户所看到的，也就是坐标系的原点在图像左上角，单位为像素。

| ![image-20220505145927099](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505145927099.png) |
| :----------------------------------------------------------: |
|               **图6 图像坐标系 -> 像素坐标系**               |

我们用 $u,v$ 来记像素的列数与行数，那么：

- 图像坐标系下的坐标系原点，在像素坐标系 $u-v$ 下记为：$o(u_0,v_0)$
- 像点 $p$，在 $u-v$ 坐标系下记为：$p(u,v)$

此外，再分别记 $dx,dy$ 为每个像素在 $x$ 轴、$y$ 轴所代表的物理尺寸大小（CMOS查询），我们很容易可以从上图可以从上图上推导出下列关系：
$$
\left\{ {\begin{array}{*{20}{c}}
  {\left( {u - {u_0}} \right)dx = x} \\ 
  {\left( {v - {v_0}} \right)dy = y} 
\end{array}} \right.
$$
将其进行移项，并写为齐次的形式，有：
$$
\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {\frac{1}{{dx}}}&0&{{u_0}} \\ 
  0&{\frac{1}{{dy}}}&{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  x \\ 
  y \\ 
  1 
\end{array}} \right]
$$

### (4) 四大坐标系总结

总结来说，相机成像系统中共包含4个坐标系：世界坐标系、相机坐标系、图像坐标系、像素坐标系，如下图所示：

| ![image-20220505145902918](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505145902918.png) |
| :----------------------------------------------------------: |
| **图7 四大坐标系：世界坐标系、相机坐标系、图像坐标系、像素坐标系** |

这四个坐标系之间的转化关系为：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {1/dx}&0&{{u_0}} \\ 
  0&{1/dy}&{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left( {\begin{array}{*{20}{c}}
  f&0&0&0 \\ 
  0&f&0&0 \\ 
  0&0&1&0 
\end{array}} \right)\left( {\begin{array}{*{20}{c}}
  {{R_{3 \times 3}}}&{{T_{3 \times 1}}} \\ 
  0&1 
\end{array}} \right)\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$
将上式合并运算：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&0&{{u_0}} \\ 
  0&{f/dy}&{{v_0}}\\ 
  0&0&1 
  
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{R_{3 \times 3}}}&{{T_{3 \times 1}}} 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$

其中：

- $[u,v]^T$：某点的像素坐标
- $[X_W,Y_W,Z_W,1]^T$：某点的世界坐标
- $dx,dy$：单个像素在 $x,y$ 方向的物理大小
- $f$：相机的焦距
- $u_0,v_0$：相机主点在像素坐标系下的坐标
- $Z_c$：尺度因子

有时我们也会增加对CMOS传感器 $u、v$ 轴的倾斜角 $\theta$ 的考虑，则上述公式变为：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&{ - f\cot \theta /dx}&{{u_0}} \\ 
  0&{f/\left( {\sin \theta dy} \right)}&{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{R_{3 \times 3}}}&{{T_{3 \times 1}}} 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$
它们都可以记为：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  \alpha &\gamma &{{u_0}} \\ 
  0&\beta &{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{R_{3 \times 3}}}&{{T_{3 \times 1}}} 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_W}} \\ 
  {{Y_W}} \\ 
  {{Z_W}} \\ 
  1 
\end{array}} \right]
$$
通常：

- **内参**：是相机的本质属性，在不调整相机焦距、光圈的情况下不会发生改变。
- **外参**：取决于相机坐标系（相机为中心）和世界坐标系（通常是标定板左上角的角点）的相互位姿关系。

### (5) 补充：归一化坐标系

| <img src="https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220505161957866.png" alt="image-20220505161957866" style="zoom:67%;" /> |
| :----------------------------------------------------------: |
|      **图8 归一化平面：成像平面距离光心距离z归一化到1**      |

> **归一化坐标系(2D)**：用于校正相机畸变校正，其将成像平面距离光心距离z归一化到1。

显然从相机坐标系到像素坐标系的转换有（在不考虑倾斜轴的情况下）：
$$
{Z_c}\left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&0&{{u_0}}&0 \\ 
  0&{f/dy}&{{v_0}}&0 \\ 
  0&0&1&0 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_C}} \\ 
  {{Y_C}} \\ 
  {{Z_C}} \\ 
  1 
\end{array}} \right]
$$
两式同除以 $Z_c$，$P$ 点被变换到了距离光心距离为1的点，即 $P_N=(X_N,Y_N)$，那么显然有：
$$
\begin{gathered}
  \left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&0&{{u_0}}&0 \\ 
  0&{f/dy}&{{v_0}}&0 \\ 
  0&0&1&0 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_C}/{Z_c}} \\ 
  {{Y_C}/{Z_c}} \\ 
  1 \\ 
  1 
\end{array}} \right] \hfill \\
   \Downarrow  \hfill \\
  \left[ {\begin{array}{*{20}{c}}
  u \\ 
  v \\ 
  1 
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
  {f/dx}&0&{{u_0}} \\ 
  0&{f/dy}&{{v_0}} \\ 
  0&0&1 
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
  {{X_N}} \\ 
  {{Y_N}} \\ 
  1 
\end{array}} \right] \hfill \\ 
\end{gathered}
$$
该坐标系经常被用于相机的畸变校正算法。

##  1.2 相机畸变

之前的模型没有考虑畸变情况，事实上，在工业相机中畸变并不明显，但是如果采用的是普通相机，那么我们最好是对镜头的畸变进行校正，主要包含：

- 径向畸变（三阶）：
  $$
  \begin{array}{l}
  \hat x = x\left( {1 + {k_1}{r^2} + {k_2}{r^4} + {k_3}{r^6}} \right)\\
  \hat y = y\left( {1 + {k_1}{r^2} + {k_2}{r^4} + {k_3}{r^6}} \right)
  \end{array}
  $$
  注：拟合系数并非越多越好，有可能发生过拟合现象，通常来说我们系数 $k_3$ 只在鱼眼相机等畸变较大的相机中才会使用。另外，针对这类畸变较大的特殊相机，有时候为了提高标定精度，我们会采用专门的相机模型进行成像描述，而非针孔相机模型。

- 切向畸变：
  $$
  \begin{array}{l}
  \hat x = x + 2{p_1}y + {p_2}\left( {{r^2} + 2{x^2}} \right)\\
  \hat y = y + 2{p_2}x + {p_1}\left( {{r^2} + 2{y^2}} \right)
  \end{array}
  $$

其中：

- $(x,y)$：无畸变归一化平面下像素点的坐标
- $x’,y'$：发生畸变后像素点的坐标
- $r^2=x^2+y^2$：像素点到中心的曲率半径

> 至于如何进行畸变校正呢？实际的高精度的畸变校正并非那么简单，后面我们配合代码端进行讲解，保证大家每一个模块都能吃透理论知识。

# 02 张正友标定法

> 很多时候我们用张正友标定法，只是调用了下OpenCV的库，并不清楚内部是如何实现的。这针对一般的使用者来说无可厚非（甚至我觉得是推荐，因为你很难很清楚地了解每一个算法的细节，而且完全没有必要，一个人的精力是有限的，你要把精力放在你着重的地方）。**但是如果你像我一样需要自己写一个高精度的相机标定算法，那么势必要读一些新的论文，要自己去实现优化过程。**

张正友标定法利用上图所示的棋盘格标定板进行标定：

| <img src="https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/image-20220422112656562.png" alt="image-20220422112656562" style="zoom:150%;" /> |
| :----------------------------------------------------------: |
|              **图2 张正友标定法拍照使用的图片**              |

在得到一张标定板图案后，基于世界坐标系、像素坐标系建立，可以得到角点相应的坐标：

- **世界坐标系**：以棋盘格左上角的角点为原点建立的三轴坐标系，由于每个棋盘格的大小是已知的，因此我们可以计算出每个角点的世界坐标系下坐标：$p=(X,Y,0)$
- **像素坐标系**：以图像左上角为原点建立的两轴坐标系，利用图像检测算法可以获得每个角点的像素坐标系下坐标：$p=(u,v)$

## 2.1 求解初值

我们来回顾一下之前的方程：
$$
s\left[ {\begin{array}{*{20}{c}}
u\\
v\\
1
\end{array}} \right] = \underbrace {\left[ {\begin{array}{*{20}{c}}
{\frac{{{f_x}}}{{dx}}}&{ - \frac{{{f_y} \cdot \cot \theta }}{{dx}}}&{{u_0}}\\
0&{\frac{{{f_y}}}{{\sin \theta  \cdot dy}}}&{{v_0}}\\
0&0&1
\end{array}} \right]}_{内参}\underbrace {\left[ {\begin{array}{*{20}{c}}
R_{3 \times 3}&t_{3 \times 1}\\
\end{array}} \right]}_{外参}\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
Z\\
1
\end{array}} \right] \label{3}
$$
这个函数包含2个矩阵，多个未知数，直接去求解并不容易，我们可以将初值的求解过程分为三步：

1. 求解内参矩阵与外参矩阵的积，即**单应性矩阵**。
2. 求解内参矩阵，这个矩阵对于不同的图片来说是个定值
3. 求解外参矩阵，对于同一张图片来说，所有的角点是定值

### (1) 求解单应性矩阵

> **单应性矩阵**
>
> 1. 物体平面到成像平面的转换：
>
>    ![img](https://pic2.zhimg.com/80/v2-45c1e0c782df7b13053ccdd5d8d50119_720w.jpg)
>
> 2. 从不同位置拍摄的，同一个平面的两个图像之间的转换（转换2次），如下图所示，原来是侧向拍摄，通过单应性矩阵转换到正向：
>
>    ![img](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/v2-c65fa108859d5d41397a60744a0caf78_720w.jpg)
>
>    ![img](https://flyman-cjb.oss-cn-hangzhou.aliyuncs.com/v2-2706c8ff1c3c8f79d137691ba5b640ac_720w.jpg)

我们记旋转矩阵 $R$ 的每一列为 $R_1,R_2,R_3$，内参矩阵记为 $A$，并且标定板上任意一点的 $Z=0$，那么显然 $Eq. \ref{3}$ 有如下简化方式：
$$
s\left[ {\begin{array}{*{20}{c}}
u\\
v\\
1
\end{array}} \right] = A\left[ {\begin{array}{*{20}{c}}
{{R_1}}&{{R_2}}&{{R_3}}&t
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
0\\
1
\end{array}} \right] = A\left[ {\begin{array}{*{20}{c}}
{{R_1}}&{{R_2}}&t
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
1
\end{array}} \right]
$$
我们将 $A\left[ {\begin{array}{*{20}{c}}
{{R_1}}&{{R_2}}&t
\end{array}} \right]$ 记为矩阵 $H$，即**单应性矩阵**（非奇异的 $3 \times 3$ 矩阵），有：
$$
\left[ {\begin{array}{*{20}{c}}
u\\
v\\
1
\end{array}} \right] = \frac{1}{s}H\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
1
\end{array}} \right] = \frac{1}{s}\left[ {\begin{array}{*{20}{c}}
{{H_{11}}}&{{H_{12}}}&{{H_{13}}}\\
{{H_{21}}}&{{H_{22}}}&{{H_{23}}}\\
{{H_{31}}}&{{H_{32}}}&{{H_{33}}}
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
X\\
Y\\
1
\end{array}} \right]  \label{7}
$$
由于这里使用的是齐次坐标系，也就是说进行任意尺度的缩放（$s$：尺度因子），都不会改变上式结果，因此同乘以$\frac{1}{h_{33}}$，当单应性矩阵变为下式也成立：
$$
\left[ {\begin{array}{*{20}{c}}
{{h_{11}}/{h_{33}}}&{{h_{12}}/{h_{33}}}&{{h_{13}}/{h_{33}}}\\
{{h_{21}}/{h_{33}}}&{{h_{22}}/{h_{33}}}&{{h_{23}}/{h_{33}}}\\
{{h_{31}}/{h_{33}}}&{{h_{32}}/{h_{33}}}&1
\end{array}} \right]
$$
即单应性矩阵只有8个自由度（未知数），而非9个。我们将之前的  $Eq. \ref{7}$ 展开，消去尺度因子 $s$，可得：
$$
\left. \begin{array}{l}
s \cdot u &= {H_{11}}X + {H_{12}}Y + {H_{13}}\\
s \cdot v &= {H_{21}}X + {H_{22}}Y + {H_{23}}\\
s &= {H_{31}}X + {H_{32}}Y + {H_{33}}
\end{array} \right\} \to \begin{array}{*{20}{c}}
{u = \frac{{{H_{11}}X + {H_{12}}Y + {H_{13}}}}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}\\
{v = \frac{{{H_{21}}X + {H_{22}}Y + {H_{23}}}}{{{H_{31}}X + {H_{32}}Y + {H_{33}}}}}
\end{array}
$$
进一步变换：
$$
\begin{array}{c}
\left\{ {\begin{array}{*{20}{c}}
{u\left( {{h_{31}}X + {h_{32}}Y + {h_{33}}} \right) = {h_{11}}X + {h_{12}}Y + {h_{13}}}\\
{v\left( {{h_{31}}X + {h_{32}}Y + {h_{33}}} \right) = {h_{21}}X + {h_{22}}Y + {h_{23}}}
\end{array}} \right.
\\
 \downarrow 
 \\
\left\{ {\begin{array}{*{20}{c}}
{uX \cdot {h_{31}} + uY \cdot {h_{32}} + u \cdot {h_{33}} - X \cdot {h_{11}} - Y \cdot {h_{12}} - {h_{13}} = 0}\\
{vX \cdot {h_{31}} + vY \cdot {h_{32}} + v \cdot {h_{33}} - X \cdot {h_{21}} - Y \cdot {h_{22}} - {h_{23}} = 0}
\end{array}} \right.
\end{array}
$$

即线性方程组含有8个未知数，提供了2组约束。因此当一张图片上的标定板角点 $ n \ge 4$，我们即可以利用**最小二乘法**来求得最佳的单应性矩阵 $H$。

### (2) 求解内参矩阵

已经求得矩阵：$H = \left[ {\begin{array}{*{20}{c}}
{{H_1}}&{{H_2}}&{{H_3}}
\end{array}} \right] = A\left[ {\begin{array}{*{20}{c}}
{R1}&{R2}&t
\end{array}} \right]$，接下来需要求解相机的内参矩阵 $A$。由于 $r_1,r_2$  作为 [旋转矩阵](https://zhuanlan.zhihu.com/p/419854977) $R$ 的两列单位正交，即：
$$
\begin{array}{C}
R{_1^T}R_2 = 0\\
R{_1^T}R_1 = R{_2^T}R_2 = 1
\end{array} \label{11}
$$
由 $H$ 和 $R_1、R_2$ 关系可得：
$$
\begin{array}{l}
R_1 = {A^{ - 1}}H_1\\
R_2 = {A^{ - 1}}H_2
\end{array}
$$
联立上述两式可得：
$$
\begin{array}{C}
{\left( {{A^{ - 1}}{H_1}} \right)^T}\left( {{A^{ - 1}}{H_2}} \right) = 0\\
{\left( {{A^{ - 1}}{H_1}} \right)^T}\left( {{A^{ - 1}}{H_1}} \right) = {\left( {{A^{ - 1}}{H_2}} \right)^T}\left( {{A^{ - 1}}{H_2}} \right) = 1\\
 \downarrow \\
H_1^T{A^{ - T}}{A^{ - 1}}{H_2} = 0\\
H_1^T{A^{ - T}}{A^{ - 1}}{H_1} = H_2^T{A^{ - T}}{A^{ - 1}}{H_2} = 1 
\end{array} \label{13}
$$
由于都出现了$A^{-T} A ^ {-1}$，并且是对称矩阵由于 ${\left( {{A^{ - T}}{A^{ - 1}}} \right)^T} = {A^{ - T}}{A^{ - 1}}$，我们记：
$$
A^{-T}A^{-1}=B=\left[ {\begin{array}{*{20}{c}}
{{B_{11}}}&{{B_{12}}}&{{B_{13}}}\\
{{B_{21}}}&{{B_{22}}}&{{B_{23}}}\\
{{B_{31}}}&{{B_{32}}}&{{B_{33}}}
\end{array}} \right] =\left[ {\begin{array}{*{20}{c}}
{{B_{11}}}&{{B_{12}}}&{{B_{13}}}\\
{{B_{12}}}&{{B_{22}}}&{{B_{23}}}\\
{{B_{13}}}&{{B_{23}}}&{{B_{33}}}
\end{array}} \right]
$$
于是 $Eq. \ref{13}$ 可以写为：
$$
H_1^TB{H_2} = 0\\
H_1^TB{H_1} = H_2^TB{H_2} = 1
$$
上述式子都可以写为$H_i^TBH_j$的形式：
$$
\begin{array}{l}
H_i^TB{H_j} 
&= \left[ {\begin{array}{*{20}{c}}
{{H_{1i}}}&{{H_{2i}}}&{{H_{3i}}}
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{{B_{11}}}&{{B_{12}}}&{{B_{13}}}\\
{{B_{12}}}&{{B_{22}}}&{{B_{23}}}\\
{{B_{13}}}&{{B_{23}}}&{{B_{33}}}
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{{H_{1j}}}\\
{{H_{2j}}}\\
{{H_{3j}}}
\end{array}} \right]\\

 &= {\left[ {\begin{array}{*{20}{c}}
{{H_{1i}}{B_{11}} + {H_{2i}}{B_{12}} + {H_{3i}}{B_{13}}}\\
{{H_{1i}}{B_{12}} + {H_{2i}}{B_{22}} + {H_{3i}}{B_{23}}}\\
{{H_{1i}}{B_{13}} + {H_{2i}}{B_{23}} + {H_{3i}}{B_{33}}}
\end{array}} \right]^T}\left[ {\begin{array}{*{20}{c}}
{{H_{1j}}}\\
{{H_{2j}}}\\
{{H_{3j}}}
\end{array}} \right]\\

 &= \left( {{H_{1i}}{B_{11}} + {H_{2i}}{B_{12}} + {H_{3i}}{B_{13}}} \right){H_{1j}} + \left( {{H_{1i}}{B_{12}} + {H_{2i}}{B_{22}} + {H_{3i}}{B_{23}}} \right){H_{2j}}\\
 &\quad + \left( {{H_{1i}}{B_{13}} + {H_{2i}}{B_{23}} + {H_{3i}}{B_{33}}} \right){H_{3j}}\\
 &= \left( {{H_{1i}}{H_{1j}}} \right){B_{11}} + \left( {{H_{2i}}{H_{1j}} + {H_{1i}}{H_{2j}}} \right){B_{12}} + \left( {{H_{3i}}{H_{1i}} + {H_{1i}}{H_{3j}}} \right){B_{13}}\\
 & \quad + \left( {{H_{2i}}{H_{2j}}} \right){B_{22}} + \left( {{H_{3i}}{H_{2j}} + {H_{2i}}{H_{3j}}} \right){B_{23}} + \left( {{H_{3i}}{H_{3j}}} \right){B_{33}}
\end{array}
$$
写成矩阵形式 ：
$$
v_{ij}^Tb = {\left[ {\begin{array}{*{20}{c}}
{{H_{1i}}{H_{1j}}}\\
{{H_{2i}}{H_{1j}} + {H_{1i}}{H_{2j}}}\\
{{H_{2i}}{H_{2j}}}\\
{{H_{3i}}{H_{1i}} + {H_{1i}}{H_{3j}}}\\
{{H_{3i}}{H_{2j}} + {H_{2i}}{H_{3j}}}\\
{{H_{3i}}{H_{3j}}}
\end{array}} \right]^T}\left[ {\begin{array}{*{20}{c}}
{{B_{11}}}\\
{{B_{12}}}\\
{{B_{22}}}\\
{{B_{13}}}\\
{{B_{23}}}\\
{{B_{33}}}
\end{array}} \right]
$$
结合 $Eq. \ref{11}$ $R_1、R_2$ 单位正交得到的约束：
$$
\begin{array}{*{20}{c}}
{v_{12}^Tb = 0}\\
{v_{11}^Tb = v_{22}^Tb = 1}
\end{array} \to \left[ {\begin{array}{*{20}{c}}
{v_{12}^T}\\
{v_{11}^T - v_{22}^T}
\end{array}} \right]b = vb = 1
$$
由于 $H$ 是已知的，也就是 $v$ 是已知的，该方程包含有6个未知数 $B_{ij}$，2个约束，因此需要至少3组数据，通过最小二乘法即可获得 $b$。因为一个标定板的位姿仅提供一个 $v$ 的值（$v$ 是有单应性矩阵 $H$ 构成的），因此至少需要3张标定板图片。通常我们利用 15 到 20 张图片，通过最小二乘法拟合获得 $b$ 的最佳值。

---

在获得 $b$ 后，我们进而可以获得 $B$ 矩阵，记相机内参：
$$
A = \left[ {\begin{array}{*{20}{c}}
{{f_x}/dx}&{ - \cot \theta /dx}&{{u_0}}\\
0&{1/dy \cdot \sin \theta }&{{v_0}}\\
0&0&1
\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
\alpha &\gamma &{{u_0}}\\
0&\beta &{{v_0}}\\
0&0&1
\end{array}} \right]
$$
于是 $A^{-1}$（增广矩阵求逆）：
$$
\begin{array}{l}{A^{ - 1}}
 \to \left[ {\begin{array}{*{20}{c}}
\alpha &\gamma &{{\mu _0}}&1&0&0\\
0&\beta &{{v_0}}&0&1&0\\
0&0&1&0&0&1
\end{array}} \right] \to \left[ {\begin{array}{*{20}{c}}
1&{\frac{\gamma }{\alpha }}&{\frac{{{\mu _0}}}{\alpha }}&{\frac{1}{\alpha }}&0&0\\
0&1&{\frac{{{v_0}}}{\beta }}&0&{\frac{1}{\beta }}&0\\
0&0&1&0&0&1
\end{array}} \right]\\
 \to \left[ {\begin{array}{*{20}{c}}
1&0&{\frac{{{\mu _0}}}{\alpha } - \frac{{\gamma {v_0}}}{{\alpha \beta }}}&{\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&0\\
0&1&{\frac{{{v_0}}}{\beta }}&0&{\frac{1}{\beta }}&0\\
0&0&1&0&0&1
\end{array}} \right] \to \left[ {\begin{array}{*{20}{c}}
1&0&0&{\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{\gamma {v_{0 - }}\beta {\mu _0}}}{{\alpha \beta }}}\\
0&1&0&0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }}\\
0&0&1&0&0&1
\end{array}} \right]\\
 \to {A^{ - 1}} = \left[ {\begin{array}{*{20}{c}}
{\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{\gamma {v_{0 - }}\beta {\mu _0}}}{{\alpha \beta }}}\\
0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }}\\
0&0&1
\end{array}} \right]
\end{array}
$$
即 $A^{-1}$：
$$
\begin{array}{l}
{A^{ - 1}} &
\to \left[ {\begin{array}{*{20}{c}}
\alpha &\gamma &{{\mu _0}}&1&0&0\\
0&\beta &{{v_0}}&0&1&0\\
0&0&1&0&0&1
\end{array}} \right] \to \left[ {\begin{array}{*{20}{c}}
1&{\frac{\gamma }{\alpha }}&{\frac{{{\mu _0}}}{\alpha }}&{\frac{1}{\alpha }}&0&0\\
0&1&{\frac{{{v_0}}}{\beta }}&0&{\frac{1}{\beta }}&0\\
0&0&1&0&0&1
\end{array}} \right]\\

&\to \left[ {\begin{array}{*{20}{c}}
1&0&{\frac{{{\mu _0}}}{\alpha } - \frac{{\gamma {v_0}}}{{\alpha \beta }}}&{\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&0\\
0&1&{\frac{{{v_0}}}{\beta }}&0&{\frac{1}{\beta }}&0\\
0&0&1&0&0&1
\end{array}} \right] \to \left[ {\begin{array}{*{20}{c}}
1&0&0&{\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{\gamma {v_{0 - }}\beta {\mu _0}}}{{\alpha \beta }}}\\
0&1&0&0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }}\\
0&0&1&0&0&1
\end{array}} \right]\\
 &\to  \left[ {\begin{array}{*{20}{c}}
{\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{\gamma {v_{0 - }}\beta {\mu _0}}}{{\alpha \beta }}}\\
0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }}\\
0&0&1
\end{array}} \right]
\end{array}
$$

于是：
$$
\begin{array}{l}
B &= {A^{ - T}}{A^{ - 1}} 
\\

&= \left[ {\begin{array}{*{20}{c}}
{\frac{1}{\alpha }}&0&0\\
{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{1}{\beta }}&0\\
{\frac{{\gamma {v_0} - \beta {\mu _0}}}{{\alpha \beta }}}&{ - \frac{{{v_0}}}{\beta }}&1
\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
{\frac{1}{\alpha }}&{ - \frac{\gamma }{{\alpha \beta }}}&{\frac{{\gamma {v_0} - \beta {\mu _0}}}{{\alpha \beta }}}\\
0&{\frac{1}{\beta }}&{ - \frac{{{v_0}}}{\beta }}\\
0&0&1
\end{array}} \right]\\

& = \left[ {\begin{array}{*{20}{c}}
{\frac{1}{{{\alpha ^2}}}}&{ - \frac{\gamma }{{{\alpha ^2}\beta }}}&{\frac{{\gamma {v_{0 - }}\beta {\mu _0}}}{{{\alpha ^2}\beta }}}\\
{ - \frac{\gamma }{{{\alpha ^2}\beta }}}&{\frac{{{\gamma ^2}}}{{{\alpha ^2}{\beta ^2}}} + \frac{1}{{{\beta ^2}}}}&{\frac{{\beta {\mu _0} - \gamma {v_0}}}{{{\alpha ^2}{\beta ^2}}} - \frac{{{v_0}}}{{{\beta ^2}}}}\\
{\frac{{\gamma {v_0} - \beta {\mu _0}}}{{{\alpha ^2}\beta }}}&{\frac{{\gamma \left( {\beta {\mu _0} - \gamma {v_0}} \right)}}{{{\alpha ^2}{\beta ^2}}} - \frac{{{v_0}}}{{{\beta ^2}}}}&{\frac{{{{\left( {\gamma {v_0} - \beta {\mu _0}} \right)}^2}}}{{{\alpha ^2}{\beta ^2}}} + \frac{{v_0^2}}{{{\beta ^2}}} + 1}
\end{array}} \right] 
\\
&= \left[ {\begin{array}{*{20}{c}}
{{B_{11}}}&{{B_{12}}}&{{B_{13}}}\\
{{B_{12}}}&{{B_{22}}}&{{B_{23}}}\\
{{B_{13}}}&{{B_{23}}}&{{B_{33}}}
\end{array}} \right]
\end{array}
$$
可得（推导较为复杂）：
$$
\begin{array}{l}
\alpha  &= \sqrt {\frac{1}{{{B_{11}}}}} \\
\beta   &= \sqrt {\frac{{{B_{11}}}}{{{B_{11}}{B_{22}} - B_{12}^2}}} \\
\gamma  &=  - {B_{12}}{\alpha ^2}\beta \\
{v_0}   &= \frac{{{B_{12}}{B_{13}} - {B_{11}}{B_{23}}}}{{{B_{11}}{B_{22}} - B_{12}^2}}\\
{u_0}   &= \frac{{\gamma {v_0}}}{\beta } - {B_{13}}{\alpha ^2}
\end{array}
$$
获得这些参数即可得到相机的内参矩阵。

### (3) 求解外参矩阵

> 对于同一个相机，相机内参取决于相机的结构、光学参数，无论标定板与相机之间的位置关系如何变化，相机的内参矩阵都不会发生改变。这也是我们可以利用不同位姿的标定板图片求解相机内参 $A$ 的原因。

之前的方程：
$$
A\left[ {\begin{array}{*{20}{c}}
{{R_1}}&{{R_2}}&t
\end{array}} \right] = H
$$
之前我们已经求解得到：单应性矩阵 $H$（对于同一张图片上相同，不同图片不同），内参矩阵 $A$（对于不同图片，它们的值都相同），因此：
$$
\left[ {\begin{array}{*{20}{c}}
{{R_1}}&{{R_2}}&t
\end{array}} \right] = {A^{ - 1}}H
$$
由于张正友标定法将世界坐标系原点选取在棋盘格上，棋盘格上任意一点的物理坐标：$Z=0$，因此并没有约束可以将 $R_3$ 直接求出，但是 $R_3$ 要使得 $R$ 为单位正交，因此可以通过构建[叉乘](https://mp.weixin.qq.com/s/WsUv6vD4QUywK8dZXDvxZw)（生成的向量正交于 $R_1、R_2$）：
$$
R_3 = R_1 \times R_2
$$
$R_3$ 与 $R_1、R_2$ 均正交，通过最终的缩放，即可得到单位正交的 $R_3$，进而得到最终的旋转矩阵 $R$。

## 2.2 相机畸变





## 2.3 L-M 算法参数优化











































